function $(e,t){return(t||document).querySelector(e)}function $$(e,t){return[].slice.call((t||document).querySelectorAll(e))}let nonce=null,selected=null;if(window.location.search){const e=window.location.search.substring("?").match(/\bnonce=([^&\?]+)\b/);e&&(nonce=e[1])}const pending_promises={};function initialize(){nonce&&document.body.setAttribute("inline",""),document.body.setAttribute("loaded","");const c=$("iframe"),v=(c.contentWindow.addEventListener("data",n=>{const o=$("div.domains > div[selected]");if(o){let[e,t]=o.data;const i={},{type:s,text:a,caption:r}=(!0===t&&(t={}),n.data);a?t[s]=a:void 0!==t[s]&&delete t[s],Object.keys(t).length||(t=!0),o.data[1]=i["domain:"+e]=t,chrome.storage.local.set(i,()=>{}),r&&chrome.storage.local.get(["functions"],e=>{let t=e.functions||{};t[s]||(t[s]={}),a?t[s][r]=a:delete t[s][r],Object.keys(t[s]).length||delete t[s],(t=Object.keys(t).length?t:void 0)?chrome.storage.local.set({functions:t},()=>{}):chrome.storage.local.remove("functions"),c.contentWindow.setFunction({type:s,caption:r,text:a},"Saved")})}}),c.contentWindow.addEventListener("trigger",e=>{var t=$("div.domains > div[selected]");if(t){var[t]=t.data,{varname:e,value:n}=e.data;const o={};o[e]=n;e={request:{triggerUserControls:o,domain:t}};chrome.runtime.sendMessage(e)}}),c.contentWindow.addEventListener("statsopen",e=>{chrome.tabs.getCurrent(e=>{chrome.tabs.sendMessage(e.id,{dir:"from",method:"statsopen"})})}),c.contentWindow.addEventListener("tabchange",e=>{const n=e.selected;chrome.tabs.getCurrent(e=>{var t={dir:"from",method:"tabchange",selected:n};chrome.tabs.sendMessage(e.id,t)})}),c.contentWindow.addEventListener("request",e=>{const{name:t,args:n}=e.data;o(t,n).then(e=>{c.contentWindow&&c.contentWindow.onResponse&&c.contentWindow.onResponse(t,e)}).catch(e=>{console.log("error in request",e)})}),{width:120,height:200,interval:1e3,color:{kernel:"red",user:"orange",idle:"green",grid:"lightgrey",label:"rgba(224, 224, 224, 1)"},processors:0,grid:[50,100,155],draw_handler:null,index:0,samples:[],graphs:[],last:null});c.contentWindow.addEventListener("show_cpuperformance",e=>{{const u=c.contentWindow.document,g=u.querySelector('div.tab[tab="cpuperformance"] div.graphs');v.draw_handler=(t,e)=>{if(t){const{width:s,height:a,samples:r,graphs:g,color:c,grid:n}=v;r.push(t),r.length>s&&r.splice(0,r.length-s),g.forEach((e,o)=>{const i=e.getContext("2d");i.clearRect(0,0,s,a),i.lineWidth=1,i.globalAlpha=1,n.forEach(e=>{i.beginPath(),i.strokeStyle=c.grid,i.moveTo(0,e),i.lineTo(s,e),i.stroke()}),r.forEach((e,t)=>{var e=e[o],t=s-r.length+t,n=Math.round(e.kernel/e.total*a),e=Math.round(e.user/e.total*a);i.beginPath(),i.moveTo(t,a),i.strokeStyle=c.kernel,i.lineTo(t,a-n),i.stroke(),i.beginPath(),i.moveTo(t,a-n),i.strokeStyle=c.user,i.lineTo(t,a-n-e),i.stroke(),i.beginPath(),i.moveTo(t,a-n-e),i.strokeStyle=c.idle,i.lineTo(t,0),i.stroke()});e=100-t?.[o].idle;isNaN(e)||(i.font="40px sans-serif",i.fillStyle=c.label,i.fillText(Math.max(0,e)+"%",5,45))}),v.index+=1}else{const{width:o,height:i,processors:d,color:l,grid:m}=v;for(let e=0;e<d;++e){const h=u.createElement("canvas");h.width=o,h.height=i,v.graphs.push(h),g.appendChild(h),v.graphs.forEach((e,t)=>{const n=e.getContext("2d");n.clearRect(0,0,o,i),n.lineWidth=1,n.globalAlpha=1,m.forEach(e=>{n.beginPath(),n.strokeStyle=l.grid,n.moveTo(0,e),n.lineTo(o,e),n.stroke()})})}}}}var t;v.timer||(t=()=>{chrome.system.cpu.getInfo(e=>{var n,e=e.processors.map(e=>e.usage);v.processors||(v.processors=e.length);const{last:t,draw_handler:o}=v;let i=null;t&&(i=(n=t,e.map((e,t)=>[e,n[t]]).map(([t,n])=>Object.fromEntries(Object.keys(t).map(e=>[e,t[e]-n[e]]))))),v.last=e,o&&o(i,e)})},setTimeout(t,0),v.timer=setInterval(t,v.interval))}),c.contentWindow.addEventListener("hide_cpuperformance",e=>{v.timer&&(clearInterval(v.timer),delete v.timer,v.last=null);{v.draw_handler=null;const t=c.contentWindow.document;return t.querySelector('div.tab[tab="cpuperformance"] div.graphs').innerHTML="",v.graphs.length=0,v.samples.length=0,void(v.index=0)}});let a="";c.contentWindow.addEventListener("settings",e=>{e=e.data;Object.keys(e).length?chrome.storage.local.set(Object.fromEntries([["settings",e]])):chrome.storage.local.remove("settings")});const o=(e,t)=>{const n=(""+Math.random()).substring(2,10),o={function:e,args:t};return new Promise((e,t)=>{pending_promises[n]={request:o,resolve:e,reject:t},chrome.tabs.getCurrent(e=>{var t={dir:"from",id:n,request:o};chrome.tabs.sendMessage(e.id,t)})})},s=(n,e)=>{var t=!0!==e;const o=$("template#domain-item");let i=o.content.cloneNode(!0);const s=i.querySelector("div");s.data=[n,e],s.setAttribute("name","domain:"+n),t&&s.setAttribute("customize",""),setTimeout(()=>{chrome.storage.local.get(["favicon:"+n],e=>{e=e["favicon:"+n];const t=$("div.domains").querySelector(`div[name="domain:${n}"] img.favicon`);t&&(e?t.src=e:t.style.display="none")})},100),i.querySelector("span.title").innerText=i.querySelector("span.title").title=n,i.querySelector("button.close").onclick=e=>{e.stopPropagation();var[e]=e.currentTarget.parentNode.data;chrome.storage.local.remove("domain:"+e),chrome.storage.local.remove("favicon:"+e)},$("div.domains").appendChild(i.querySelector("div")),s.onclick=e=>{e.stopPropagation();const t=e.currentTarget;let[,n]=t.data;t.hasAttribute("customize")||!0!==n||(t.setAttribute("customize",""),n=t.data[1]={});const o=$("div.domains > div[selected]");o&&o.removeAttribute("selected"),t.setAttribute("selected",""),c.contentWindow.setData(n)}},i=(chrome.storage.local.get(n=>{if(n.settings&&setTimeout(async()=>{if(c.contentWindow)if(c.contentWindow.setSettings(n.settings),n.settings.urls){const t=n.settings.urls.split("\n").map(e=>e.trim()).filter(e=>!!e),s={};await Promise.all(t.map(async t=>{try{let e=await fetch(t,{cache:"no-cache"});for(var n in e=await e.json()){for(var o in e[n]){const i=e[n][o];i.match(/^(async\s+)?function\s*(\w+\s*)?\(([^\)]*)\)\s*\{([\s\S]*)\}\s*$/)||(console.warn("ignored: invalid function:",n,o),delete e[n][o])}s[n]?Object.assign(s[n],e[n]):s[n]=e[n]}}catch(e){console.error("failed to fetch or parse from "+t,e)}})),c.contentWindow&&Object.keys(s).length&&c.contentWindow.addFunctions(s,"External")}else{var e;n.settings.theme&&(e="dark"==(a=n.settings.theme||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"))?"invert(1)":"none",$("div.content").style.setProperty("filter",e,"important"))}else console.log("ignoring settings as iframe is not ready")},200),n.functions&&setTimeout(async()=>{c.contentWindow&&c.contentWindow.addFunctions(n.functions,"Saved")},200),Object.keys(n).filter(e=>e.startsWith("domain:")).map(e=>[e.substring("domain:".length),n[e]]).forEach(e=>{var[e,t]=e;s(e,t)}),nonce&&selected){const e=$(`div.domains > div[name="domain:${selected}"]`);e?e.click():console.log("not found",selected),selected=null}}),chrome.storage.onChanged.addListener((e,t)=>{if("local"==t)for(var n in e){var o,i=e[n];n.startsWith("domain:")?(o=n.substring("domain:".length),void 0!==i.newValue&&void 0===i.oldValue?s(o,i.newValue):void 0===i.newValue&&void 0!==i.oldValue&&(t=>{const e=[].slice.call(document.querySelectorAll("div.domains > div")).filter(e=>e.data&&e.data[0]==t);e.forEach(e=>{e.hasAttribute("selected")&&(e.removeAttribute("selected"),c.contentWindow.clearData()),$("div.domains").removeChild(e)})})(o)):"settings"==n?(o=a,(i=(i.newValue||{}).theme)!=o&&(i="dark"==(a=i||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"))?"invert(1)":"none",$("div.content").style.setProperty("filter",i,"important"))):n}}),$("div.search > input").onkeyup=$("div.search > input").onchange=e=>{if(e&&"keyup"==e.type&&"Enter"===e.key)$("div.search > button.add").click();else{const n=$("div.search > input").value;n?$$("div.domains > div:not(.search)").forEach(e=>{let t=e.getAttribute("name");t&&t.startsWith("domain:")&&((t=t.substring(6)).indexOf(n)<0?e.hasAttribute("hidden")||e.setAttribute("hidden",""):e.hasAttribute("hidden")&&e.removeAttribute("hidden"))}):$$("div.domains > div:not(.search)[hidden]").forEach(e=>{e.removeAttribute("hidden")})}});$("div.search > button.add").onclick=e=>{const n=$("div.search > input").value;n?chrome.storage.local.get(["domain:"+n],e=>{if(!e["domain:"+n]){const t={};t["domain:"+n]={},chrome.storage.local.set(t,()=>{$("div.search > input").value="",i()})}}):($("div.search > input").value="domain-to-add.com",$("div.search > input").select(),$("div.search > input").focus())}}chrome.runtime.onMessage.addListener(function(e,t,n){if(e.options){if(!e.nonce||e.nonce===nonce)switch(e.options.type){case"select":if(e.options.domain){var o=e.options.domain;const i=$(`div.domains > div[name="domain:${o}"]`);i?i.click():selected=o}break;case"setUserControls":if(e.options.domain){const s=$(`div.domains > div[name="domain:${e.options.domain}"]`);if(s&&s.hasAttribute("selected")){const a=$("iframe");a&&a.contentWindow&&a.contentWindow.setUserControls(e.options.data)}}n({});break;case"setMediastats":if(e.options.domain){const r=$(`div.domains > div[name="domain:${e.options.domain}"]`);if(r&&r.hasAttribute("selected")){const c=$("iframe");c&&c.contentWindow&&(o=e.options.data,c.contentWindow.setMediastats(...o))}}n({});break;case"setTab":if(e.options.selected){const d=$("iframe");d&&d.contentWindow&&d.contentWindow.setTab(e.options.selected)}break;case"setfontsize":if(e.options.fontsize){const l=$("iframe");l&&l.contentWindow&&l.contentWindow.setSettings(result.settings)}}}else if(e.id&&pending_promises[e.id]){const{resolve:m,reject:h}=pending_promises[e.id];delete pending_promises[e.id],e.reject?h(e.reject):m(e.resolve),n()}}),window.onload=()=>{initialize()};
