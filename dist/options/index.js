function $(e,t){return(t||document).querySelector(e)}function $$(e,t){return[].slice.call((t||document).querySelectorAll(e))}let nonce=null,selected=null;if(window.location.search){const e=window.location.search.substring("?").match(/\bnonce=([^&\?]+)\b/);e&&(nonce=e[1])}const pending_promises={};function initialize(){nonce&&document.body.setAttribute("inline",""),document.body.setAttribute("loaded","");const d=$("iframe");d.contentWindow.addEventListener("data",n=>{const o=$("div.domains > div[selected]");if(o){let[e,t]=o.data;const i={},{type:s,text:a,caption:c}=(!0===t&&(t={}),n.data);a?t[s]=a:void 0!==t[s]&&delete t[s],Object.keys(t).length||(t=!0),o.data[1]=i["domain:"+e]=t,chrome.storage.local.set(i,()=>{}),c&&chrome.storage.local.get(["functions"],e=>{let t=e.functions||{};t[s]||(t[s]={}),a?t[s][c]=a:delete t[s][c],Object.keys(t[s]).length||delete t[s],(t=Object.keys(t).length?t:void 0)?chrome.storage.local.set({functions:t},()=>{}):chrome.storage.local.remove("functions"),d.contentWindow.setFunction({type:s,caption:c,text:a},"Saved")})}}),d.contentWindow.addEventListener("tabchange",e=>{const n=e.selected;chrome.tabs.getCurrent(e=>{var t={dir:"from",method:"tabchange",selected:n};chrome.tabs.sendMessage(e.id,t)})}),d.contentWindow.addEventListener("request",e=>{const{name:t,args:n}=e.data;o(t,n).then(e=>{d.contentWindow&&d.contentWindow.onResponse&&d.contentWindow.onResponse(t,e)}).catch(e=>{console.log("error in request",e)})});let s="";d.contentWindow.addEventListener("settings",e=>{e=e.data;Object.keys(e).length?chrome.storage.local.set(Object.fromEntries([["settings",e]])):chrome.storage.local.remove("settings")});const o=(e,t)=>{const n=(""+Math.random()).substring(2,10),o={function:e,args:t};return new Promise((e,t)=>{pending_promises[n]={request:o,resolve:e,reject:t},chrome.tabs.getCurrent(e=>{var t={dir:"from",id:n,request:o};chrome.tabs.sendMessage(e.id,t)})})},a=(n,e)=>{var t=!0!==e;const o=$("template#domain-item");let i=o.content.cloneNode(!0);const s=i.querySelector("div");s.data=[n,e],s.setAttribute("name","domain:"+n),t&&s.setAttribute("customize",""),setTimeout(()=>{chrome.storage.local.get(["favicon:"+n],e=>{e=e["favicon:"+n];const t=$("div.domains").querySelector(`div[name="domain:${n}"] img.favicon`);t&&(e?t.src=e:t.style.display="none")})},100),i.querySelector("span.title").innerText=i.querySelector("span.title").title=n,i.querySelector("button.close").onclick=e=>{e.stopPropagation();var[e]=e.currentTarget.parentNode.data;chrome.storage.local.remove("domain:"+e),chrome.storage.local.remove("favicon:"+e)},$("div.domains").appendChild(i.querySelector("div")),s.onclick=e=>{e.stopPropagation();const t=e.currentTarget;let[,n]=t.data;t.hasAttribute("customize")||!0!==n||(t.setAttribute("customize",""),n=t.data[1]={});const o=$("div.domains > div[selected]");o&&o.removeAttribute("selected"),t.setAttribute("selected",""),d.contentWindow.setData(n)}},i=(chrome.storage.local.get(t=>{if(t.settings&&setTimeout(async()=>{var e;d.contentWindow?(d.contentWindow.setSettings(t.settings),t.settings.theme&&(e="dark"==(s=t.settings.theme||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"))?"invert(1)":"none",$("div.content").style.setProperty("filter",e,"important"))):console.log("ignoring settings as iframe is not ready")},200),t.functions&&setTimeout(async()=>{d.contentWindow&&d.contentWindow.addFunctions(t.functions,"Saved")},200),Object.keys(t).filter(e=>e.startsWith("domain:")).map(e=>[e.substring("domain:".length),t[e]]).forEach(e=>{var[e,t]=e;a(e,t)}),nonce&&selected){const e=$(`div.domains > div[name="domain:${selected}"]`);e?e.click():console.log("not found",selected),selected=null}}),chrome.storage.onChanged.addListener((e,t)=>{if("local"==t)for(var n in e){var o,i=e[n];n.startsWith("domain:")?(o=n.substring("domain:".length),void 0!==i.newValue&&void 0===i.oldValue?a(o,i.newValue):void 0===i.newValue&&void 0!==i.oldValue&&(t=>{const e=[].slice.call(document.querySelectorAll("div.domains > div")).filter(e=>e.data&&e.data[0]==t);e.forEach(e=>{e.hasAttribute("selected")&&(e.removeAttribute("selected"),d.contentWindow.clearData()),$("div.domains").removeChild(e)})})(o)):"settings"==n?(o=s,(i=(i.newValue||{}).theme)!=o&&(i="dark"==(s=i||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"))?"invert(1)":"none",$("div.content").style.setProperty("filter",i,"important"))):n}}),$("div.search > input").onkeyup=$("div.search > input").onchange=e=>{if(e&&"keyup"==e.type&&"Enter"===e.key)$("div.search > button.add").click();else{const n=$("div.search > input").value;n?$$("div.domains > div:not(.search)").forEach(e=>{let t=e.getAttribute("name");t&&t.startsWith("domain:")&&((t=t.substring(6)).indexOf(n)<0?e.hasAttribute("hidden")||e.setAttribute("hidden",""):e.hasAttribute("hidden")&&e.removeAttribute("hidden"))}):$$("div.domains > div:not(.search)[hidden]").forEach(e=>{e.removeAttribute("hidden")})}});$("div.search > button.add").onclick=e=>{const n=$("div.search > input").value;n?chrome.storage.local.get(["domain:"+n],e=>{if(!e["domain:"+n]){const t={};t["domain:"+n]={},chrome.storage.local.set(t,()=>{$("div.search > input").value="",i()})}}):($("div.search > input").value="domain-to-add.com",$("div.search > input").select(),$("div.search > input").focus())}}chrome.runtime.onMessage.addListener(function(e,t,n){if(e.options){if(!e.nonce||e.nonce===nonce)switch(e.options.type){case"select":if(e.options.domain){var o=e.options.domain;const i=$(`div.domains > div[name="domain:${o}"]`);i?i.click():selected=o}break;case"setTab":if(e.options.selected){const s=$("iframe");s&&s.contentWindow&&s.contentWindow.setTab(e.options.selected)}break;case"setfontsize":if(e.options.fontsize){const a=$("iframe");a&&a.contentWindow&&a.contentWindow.setSettings(result.settings)}}}else if(e.id&&pending_promises[e.id]){const{resolve:c,reject:d}=pending_promises[e.id];delete pending_promises[e.id],e.reject?d(e.reject):c(e.resolve),n()}}),window.onload=()=>{initialize()};
