(window._rtchelper||document.querySelector("html").hasAttribute("rtchelper")?function(){}:function(){const e=function(m,s,p,e){const t=e=>(""+Math.random()).substring(2,e||8),c={},v={log:window.console.log,debug:window.console.debug,info:window.console.info,warn:window.console.warn,error:window.console.error};let o="";m&&m.addEventListener("message",e=>{if(!(e.source&&e.source!==window||e.data.nonce!=s||"from"!=e.data.dir))if(e.data.method)"setprocess"==e.data.method?a(e.data.type,e.data.body):"setstrict"==e.data.method&&(o=e.data.value);else{const n=c[e.data.id];var t;n?(delete c[e.data.id],(t=e.data.response).reject?n.reject(t.reject):n.resolve(t.resolve)):v.warn("promise is already fullfilled: "+e.data.id)}});const $=["videocapture","screencapture","devicelist","mediastream","usermedia","mediacodec","mediaconnect","medianetwork","datachannel","websocket","webrequest"];function a(e,t){if(0<=$.indexOf(e))switch(e){case"videocapture":return N(t);case"screencapture":return U(t);case"devicelist":return X(t);case"mediastream":return se(t);case"usermedia":return B(t);case"mediacodec":return pe(t);case"mediaconnect":return fe(t);case"medianetwork":return he(t);case"datachannel":return me(t);case"websocket":return we(t);case"webrequest":return Ee(t)}}function r(a,e){if(m){const n=t(),r={function:a,args:e};return m.postMessage({nonce:s,dir:"to",id:n,request:r}),new Promise((e,t)=>{c[n]={request:r,resolve:e,reject:t}})}return new Promise((e,t)=>{const n=Oe(a);obj={},n&&(obj[a]=n.toString()),e(obj)})}function H(r,s){return new Promise((a,e)=>{r.pending_upload?e("already pending upload"):(r.pending_upload=!0,document.addEventListener("click",function e(t){document.removeEventListener("click",e);{const n=document.createElement("input");n.setAttribute("type","file"),n.setAttribute("accept",s||"image/*, video/*"),n.setAttribute("multiple",""),n.onchange=()=>{delete r.pending_upload,a(n.files)};try{n.click()}catch(e){v.warn("failed to click on file input")}return}}))})}const V={};function g(e){if(!e)return{params:null,process:null};var t=e.match(/^(async\s+)?function\s*(\w+\s*)?\(([^\)]*)\)\s*\{([\s\S]*)\}\s*$/);if(!t)return v.error("failed to match as valid function",e),{params:null,process:null};let n=t[3],a=t[4];n=n.split(",").map(e=>e.trim()).filter(e=>!!e);let r;return r=t[1]?(o?F:d)(n,a,!0):(o?F:d)(n,a),{params:n,process:r,is_async:!!t[1]}}function y(a,r,e){if("single"==e){if(!a.pending)return a.pending=!0,new Promise((t,n)=>{try{const e=a.apply(null,r);"object"==typeof e&&e instanceof Promise?e.then(e=>{delete a.pending,t(e)}).catch(e=>{delete a.pending,i("promise rejected:",a,e),n("promise failed")}):(delete a.pending,t(e))}catch(e){i("error in function:",a,e),n("error in function: "+e.message)}})}else{if(e)return new Promise((t,n)=>{try{const e=a.apply(null,r);"object"==typeof e&&e instanceof Promise?e.then(e=>{t(e)}).catch(e=>{i("promise rejected:",a,e),n(e)}):t(e)}catch(e){i("error in function:",a,e),n(e)}});try{return a.apply(null,r)}catch(e){throw i("error in function:",a,e),new Error("error in function: "+e.message)}}}function i(e,c,t){if(t&&t.stack&&"string"==typeof t.stack){let e=t.stack.split("\n");var n=e.findIndex(e=>!!e.match(/^\s*at (Object\.)?eval\b/));const a=e[n];e=e.slice(0,n+1),a.match(/:(\d+):(\d+)\)$/)&&(e[e.length-1]=e[e.length-1].replace(/\bat (Object\.)?eval\b/,"at function"),t.stack=e.map(e=>e.replace(/\(eval at (<anonymous>|regular_function|\w+) \(.*\), /,"(").replace(/^(.*:)(\d+)(:\d+\))$/,(e,t,n,a,r,s)=>t+(n-c.lineOffset+1)+a)).join("\n"))}v.error(e,t)}const h=Object.getPrototypeOf(async function(){}).constructor;function d(e,t,n){const a=new(n?h:Function)(e,t);return a.toString=()=>(n?"async ":"")+`function(${e.join(",")}) {
${t}
}`,a.lineOffset=3,a}function F(e,t,n){var a=["eval","Object","Number","String","Boolean","RegExp","JSON","Date","Math","console","Infinity","Array","Set","Map","NaN","Blob","URL","screen","parseInt","parseFloat","Error","Promise","fetch","FileReader","setTimeout","clearTimeout"],r=["fn","fnText","forbiddenKeys","exceptionKeys","empty","oForbiddenKeys"],s=Object.create(null),c=Object.create(null);Object.freeze(c),r.forEach(function(e){s[e]=null}),[this,self].forEach(function(e){Object.getOwnPropertyNames(e).forEach(function(e){e.match(/^[\$\w]+$/)&&!e.match(/^\d+$/)&&(s[e]=null)})}),a.forEach(function(e){delete s[e]});const o=t,i=(t=t.replace(/\beval\b/g,"eval_").replace(/\bimport\b/g,"import_"),t=['"use strict";',"var "+Object.keys(s).join(", ")+";","{",t,"}"].join("\n"),{createElement:function(e){if("img"==e||"video"==e)return document.createElement(e);throw new Error(`forbidden: document.createElement("${e}")`)}}),d=(Object.freeze(i),{get userAgent(){return navigator.userAgent},get userAgentData(){return navigator.userAgentData},get platform(){return navigator.platform}}),l=(Object.freeze(d),async()=>Promise.reject("forbidden: import")),u=()=>{throw new Error("forbidden: eval")};var p=function(){with(c)return new(n?h:Function)(["self","window","document","navigator","import_","eval_",...e],t)}();const f=function(...e){return p.call(Object.create(null),c,c,i,d,l,u,...e)};return f.toString=()=>(n?"async ":"")+`function(${e.join(",")}) {
${o}
}`,f.lineOffset=6,f}const l={enable:!1,params:null,process:null,states:[]},u={enable:!1,params:null,process:null,states:[]},f={enable:!1,params:null,process:null};function N(t){if(!m){var{params:e,process:n}=g(t);if(!n)return void(l.enable=!1);l.enable=!0,l.params=e,l.process=n}l.states.forEach(e=>{k("videocapture",e,t)})}function U(t){if(!m){var{params:e,process:n}=g(t);if(!n)return void(u.enable=!1);u.enable=!0,u.params=e,u.process=n}u.states.forEach(e=>{k("screencapture",e,t)})}function B(t){if(!m){var{params:e,process:n}=g(t);if(!n)return void(f.enable=!1);f.enable=!0,f.params=e,f.process=n}l.states.forEach(e=>{ne(e,t)})}const n={enable:!1,params:null,process:null};function X(e){var t;m||({params:e,process:t}=g(e),t?(n.enable=!0,n.params=e,n.process=t):n.enable=!1)}const b=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices),z=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices),w=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);function k(e,t,n){var{params:n,process:a}=g(n);a&&(t.args=J(e,t,n),t.process=a)}function J(e,n,t){const a=n.args=t.map(e=>{switch(e){case"canvas":return n.canvas;case"data":return n.data;case"upload":return H;default:return q(e)}});let r=t.indexOf("video"),s=(0<=r?(n.video||K(e,n),a[r]=n.video):n.video&&W(n),0<=(r=t.indexOf("videos"))?(n.videos||Y(n),a[r]=n.videos):n.videos&&Z(n),t.map((e,t)=>[e,t]).filter(e=>e[0].match(/^screen\d?$/))),c=(s.forEach(([e,t])=>{n[e]||G(n,e),a[t]=n[e]}),Object.keys(n).filter(e=>e.match(/^screen\d?$/)));return c.sort().reverse().forEach(t=>{s.findIndex(e=>e[0]==t)<0&&Q(n,t)}),a}function K(e,t){let n=t.video=null;const a=Object.assign("screencapture"==e?{video:!0}:{},t.constraints1||t.constraints);delete a.audio,(n=t.video=document.createElement("video")).autoplay=!0,a.video&&b(a).then(e=>{(n.srcObject=e)&&(t.track._attached||(t.track._attached=[]),t.track._attached.push(e.getVideoTracks()[0]))}).catch(e=>{v.error("failed to get user media",e)})}function W(e){if(e.video){const n=e.video.srcObject;if(e.video.srcObject){e.video.srcObject=null;const a=n.getVideoTracks()[0];var t=(e.track._attached||[]).findIndex(e=>e===a);0<=t&&(e.track._attached.splice(t,0),a.stop())}e.video=null}}function G(t,e){const n=t[e]=document.createElement("video");n.autoplay=!0,z({frameRate:5}).then(e=>{n.srcObject=e,t.track._attached||(t.track._attached=[]),t.track._attached.push(e.getVideoTracks()[0]),e.oninactive=e=>{n.videoWidth=0,n.videoHeight=0}}).catch(e=>{v.error("failed to get display media",e)})}function Q(e,t){if(e[t]){const a=e[t].srcObject;if(e[t].srcObject){e[t].srcObject=null;const r=a.getVideoTracks()[0];var n=(e.track._attached||[]).findIndex(e=>e===r);0<=n&&(e.track._attached.splice(n,0),r.stop())}e[t]=null}}function Y(a){let r=a.videos=[];const s=Object.assign({},a.constraints1||a.constraints);delete s.audio,s.video&&"object"==typeof s.video&&s.video.deviceId&&delete s.video.deviceId,w().then(e=>{const t=[];e.forEach(e=>{"videoinput"==e.kind&&t.push(e.deviceId)}),a.track._attached||(a.track._attached=[]),t.forEach((t,e)=>{const n=Object.assign({},s);"object"!=typeof n.video&&(n.video={}),n.video.deviceId={exact:t},b(n).then(e=>{const t=document.createElement("video");t.autoplay=!0,t.srcObject=e,a.track._attached.push(e.getVideoTracks()[0]),r.push(t)}).catch(e=>v.error("failed to get webcam: "+t,e))})}).catch(e=>v.error("enumerateDevices",e))}function Z(a){a.videos&&(a.videos.forEach(e=>{const t=e.srcObject;if(e.srcObject){e.srcObject=null;const n=t.getVideoTracks()[0];e=(a.track._attached||[]).findIndex(e=>e===n);0<=e&&(a.track._attached.splice(e,0),n.stop())}}),a.videos=null)}async function ee(e,t,n){var{params:e,process:a}=g(e.usermedia);return t=a?(t=await y(a,te({context:n,constraints:a=t&&JSON.parse(JSON.stringify(t))},e),!0))||a:t}function te(e,t){const{context:n,constraints:a}=e;return t.map(e=>{switch(e){case"constraints":return a;case"context":return n;default:return q(e)}})}function ne(e,t){e.usermedia=t,e.track&&e.constraints&&e.constraints.video&&e.track.applyConstraints(e.constraints.video).catch(e=>{v.log("error in applyConstraints",e)})}async function ae(t,e,n,s){var c=await r(n,[]),o=await r("usermedia",[]),a=await r("mediastream",[]);const i={constraints:t};"object"==typeof o&&o.usermedia&&(i.usermedia=o.usermedia,t=i.constraints1=await ee(i,t,e));let d=null;if("object"==typeof c&&c[n]){const l=document.createElement("canvas");let a="screencapture"==n?{width:1280,height:960,frameRate:5}:{width:320,height:240,frameRate:15};t&&"object"==typeof t.video&&["width","height","frameRate"].forEach(e=>{"number"==typeof t.video[e]?a[e]=t.video[e]:"object"==typeof t.video[e]&&(a[e]=t.video[e].exact||t.video[e].max||a[e])}),l.width=a.width,l.height=a.height;l.getContext("2d");const u=l.captureStream(),p=(u._rtchelp=!0,u.getVideoTracks()[0]),f=Object.assign({},t||{});delete f.video;let r=null;p.applyConstraints.bind(p);p.applyConstraints=async function(n){if("object"==typeof i.constraints&&i.constraints.video!==n&&(i.constraints.video=n),i.usermedia){var e=await ee(i,{video:n},"applyConstraints");if(!(n=e&&e.video))return;i.constraints1&&(i.constraints1.video=n)}e=a.frameRate;if(["width","height","frameRate"].forEach(e=>{"number"==typeof n[e]?a[e]=n[e]:"object"==typeof n[e]&&(a[e]=n[e].exact||n[e].max||a[e])}),l.width=a.width,l.height=a.height,e!=a.frameRate&&(r&&(clearInterval(r),r=null),r=setInterval(async()=>{var{process:e,args:t}=i;if(e&&t)try{await y(e,t,"single")}catch(e){}},1e3/a.frameRate)),i.video&&i.video.srcObject){const t=i.video.srcObject.getVideoTracks()[0];t&&"live"==t.readyState&&t.applyConstraints(n).catch(e=>{v.error("failed to applyConstraints",e)})}else i.videos&&0<i.videos.length&&i.videos.filter(e=>!!e.srcObject).forEach(e=>{const t=e.srcObject.getVideoTracks()[0];t&&"live"==t.readyState&&t.applyConstraints(n).catch(e=>{v.error("failed to applyConstraints",e)})})};o=Date.now(),o=(Object.assign(i,{data:{start:o},canvas:l,track:p,video:null,process:null,args:[]}),s.states.push(i),k(n,i,c[n]),async()=>{var{process:e,args:t}=i;if(e&&t)try{await y(e,t,"single")}catch(e){}});if(r=setInterval(o,1e3/a.frameRate),a.frameRate<=5&&setTimeout(o,0),p.addEventListener("ended",e=>{r&&(clearInterval(r),r=null),e.currentTarget._attached&&(e.currentTarget._attached.forEach(e=>{e.stop()}),e.currentTarget._attached=null)}),p.stop=()=>{r&&(clearInterval(r),r=null),p._attached&&(p._attached.forEach(e=>{e.stop()}),p._attached=null)},f.audio)try{const h=await b(f);u.addTrack(h.getAudioTracks()[0])}catch(e){}m&&m.postMessage({type:e,constraints:t},"*"),d=Promise.resolve(u)}else d=("screencapture"==n?z:b)(t);if(!j.calling&&d&&"object"==typeof a&&a.mediastream){var{params:s,process:c}=g(a.mediastream);if(c){o=E({stream:d=await d,context:"screencapture"==n?"getDisplayMedia":"getUserMedia"},s);j.calling+=1;let e;try{e=await y(c,o,!0)}finally{--j.calling}e&&(d=e),d=Promise.resolve(d)}}return d}async function re(e){return Promise.all(e.map(async e=>"devices"!==e?q(e)||Promise.resolve(void 0):w()))}navigator.mediaDevices.getUserMedia=e=>ae(e,"getUserMedia","videocapture",l),navigator.mediaDevices.getDisplayMedia=e=>ae(e,"getDisplayMedia","screencapture",u),navigator.mediaDevices.enumerateDevices=async e=>{var t,n=await r("devicelist",[]);return"object"==typeof n&&n.devicelist?({params:n,process:t}=g(n.devicelist),t?y(t,await re(n),!0)||[]:w()):w()};const j={enable:!1,params:null,process:null,calling:0};function se(e){var{params:e,process:t}=g(e);t?(j.enable=!0,j.params=e,j.process=t):(j.enable=!1,j.params=null,j.process=null)}function E(e,t){const{stream:n,context:a,track:r,source:s}=e;return(t||[]).map(e=>{switch(e){case"stream":return n;case"track":return r;case"source":return s;case"context":return a;default:return q(e)}})}function ce(t,n,a){let r=t.call(n,...a);if(!j.calling&&j.enable){var{params:t,process:a}=j,n=E({stream:r,context:"captureStream",source:n},t);j.calling+=1;let e;try{e=y(a,n)}finally{--j.calling}e&&(r=e)}return r}m&&r("mediastream",[]).then(e=>{"object"==typeof e&&e.mediastream?se(e.mediastream):j.enable=!1}),j.captureStream=HTMLMediaElement.prototype.captureStream,j.captureStreamCanvas=HTMLCanvasElement.prototype.captureStream,HTMLMediaElement.prototype.captureStream=function(...e){return ce(j.captureStream,this,e)},HTMLCanvasElement.prototype.captureStream=function(...e){return ce(j.captureStreamCanvas,this,e)};let oe=0;const ie=new Set,O=new Map;function de(e,a,c){return new Proxy(e,{construct(e,t){var n={id:a+ ++oe,state:{}};"function"==typeof c.preconstruct&&c.preconstruct(n,t);const s=new e(...t);return ie.add(s),O.set(s,n),"function"==typeof c.construct&&c.construct(s,t),new Proxy(s,{set(e,t,n){return Reflect.set(e,t,n)},get(e,r){return"function"==typeof e[r]?new Proxy(e[r],{apply(e,t,n){var a;return"function"==typeof c[r]?"close"==r?(a=c[r](s,n),setTimeout(()=>{ie.delete(s),O.delete(s)}),a):c[r](s,n):("getStats"!==r&&S(s,"method",r),Reflect.apply(e,s,n))}}):Reflect.get(e,r)}})}})}function le(r,s){return"function"==typeof s.construct&&s.construct(r),new Proxy(r,{set(e,t,n){return Reflect.set(e,t,n)},get(e,a){return"function"==typeof e[a]?new Proxy(e[a],{apply(e,t,n){return"function"==typeof s[a]?s[a](r,n):Reflect.apply(e,r,n)}}):Reflect.get(e,a)}})}function x(r,s,e){return new Promise((n,a)=>{S(r,"method",s,e).then(()=>{"addIceCandidate"!=s||e.length?r[s](...e).then(e=>{const t=[e];S(r,"method",s+"OnSuccess",t).then(()=>{n(t[0])})}).catch(e=>{const t=[e];S(r,"method",s+"OnFailure",t).then(()=>{a(t[0])})}):n()})})}function ue(e,a){return le(e,{construct:function(n){n.addEventListener("bufferedamountlow",e=>{S(a,"RTCDataChannel.event",e.type,[],n)}),n.addEventListener("close",e=>{S(a,"RTCDataChannel.event",e.type,[],n)}),n.addEventListener("error",e=>{var t=[{error:e.error}];if(S(a,"RTCDataChannel.event",e.type,t,n),!t.length)return e.preventDefault(),e.stopImmediatePropagation(),!1;e.error=t[0].error}),n.addEventListener("message",e=>{var t=[{data:e.data}];if(S(a,"RTCDataChannel.event",e.type,t,n),!t.length)return e.preventDefault(),e.stopImmediatePropagation(),!1;e.data=t[0].data}),n.addEventListener("open",e=>{S(a,"RTCDataChannel.event",e.type,[],n)})},close:function(e,t){return S(a,"RTCDataChannel.method","close",t,e),e.close(...t)},send:function(e,t){return S(a,"RTCDataChannel.method","send",t,e),e.send(...t)}})}window.RTCPeerConnection=de(window.RTCPeerConnection,"pc",{preconstruct:function(e,t){S(e,"method","preconstruct",t)},construct:function(s,e){S(s,"method","construct",e),s.addEventListener("connectionstatechange",e=>{S(s,"event",e.type,[{value:e.currentTarget.connectionState}])}),s.addEventListener("icecandidate",e=>{var t=[e.candidate];if(S(s,"event",e.type,t),!t.length)return e.preventDefault(),e.stopImmediatePropagation(),!1;e.candidate=t[0]}),s.addEventListener("icecandidateerror",e=>{S(s,"event",e.type,[{errorCode:e.errorCode,url:e.url,errorText:e.errorText}])}),s.addEventListener("iceconnectionstatechange",e=>{S(s,"event",e.type,[{value:e.currentTarget.iceConnectionState}])}),s.addEventListener("icegatheringstatechange",e=>{S(s,"event",e.type,[{value:e.currentTarget.iceGatheringState}])}),s.addEventListener("negotiationneeded",e=>{S(s,"event",e.type)}),s.addEventListener("signalingstatechange",e=>{S(s,"event",e.type,[{value:e.currentTarget.signalingState}])}),s.addEventListener("track",n=>{if(!n._intercepted){let e=n.streams&&n.streams[0],t=n.track;var a=[{track:t,stream:e}];if(S(s,"event",n.type,a),1===a.length&&a[0].track===t&&a[0].stream===e||(n.preventDefault(),n.stopImmediatePropagation()),1==a.length){t=a[0].track,e=a[0].stream;const r=new Event("track");Object.assign(r,{track:t,streams:[e]}),r._intercepted=!0,s.dispatchEvent(r)}}}),s.addEventListener("datachannel",e=>{var t=[{channel:e.channel}];if(S(s,"event",e.type,t),!t.length)return e.preventDefault(),e.stopImmediatePropagation(),!1;e.channel=ue(t[0].channel,s)})},createOffer:function(e,t){return x(e,"createOffer",t)},createAnswer:function(e,t){return x(e,"createAnswer",t)},setLocalDescription:function(e,t){return x(e,"setLocalDescription",t)},setRemoteDescription:function(e,t){return x(e,"setRemoteDescription",t)},addIceCandidate:function(e,t){return x(e,"addIceCandidate",t)},addTrack:function(e,t){return S(e,"method","addTrack",[t[0]]),e.addTrack(...t)},removeTrack:function(e,t){return S(e,"method","removeTrack",[t[0].track]),e.removeTrack(...t)},createDataChannel:function(e,t){return S(e,"method","createDataChannel",t),ue(e.createDataChannel(...t),e)},close:function(e,t){const n=O.get(e);return n&&(n.timer1&&(clearTimeout(n.timer1),delete n.timer1),n.timer2&&(clearInterval(n.timer2),delete n.timer2)),S(e,"method","close"),e.close(...t)}});const T={enable:!1,params:null,process:null,is_async:!1};function pe(e){var{params:e,process:t,is_async:n}=g(e);t?(T.enable=!0,T.params=e,T.process=t,T.is_async=n):T.enable=!1}m&&r("mediacodec",[]).then(e=>{"object"==typeof e&&e.mediacodec?pe(e.mediacodec):T.enable=!1});const C={enable:!1,params:null,process:null};function fe(e){var{params:e,process:t}=g(e);t?(C.enable=!0,C.params=e,C.process=t):C.enable=!1}m&&r("mediaconnect",[]).then(e=>{"object"==typeof e&&e.mediaconnect?fe(e.mediaconnect):C.enable=!1});const _={enable:!1,params:null,process:null};function he(e){var{params:e,process:t}=g(e);t?(_.enable=!0,_.params=e,_.process=t):_.enable=!1}m&&r("medianetwork",[]).then(e=>{"object"==typeof e&&e.medianetwork?he(e.medianetwork):_.enable=!1});const D={enable:!1,params:null,process:null};function me(e){var{params:e,process:t}=g(e);t?(D.enable=!0,D.params=e,D.process=t):D.enable=!1}function ve(t,n,e){return e.map(e=>{switch(e){case"id":return t.id;case"data":return t.state;case"config":case"configuration":return n[0];case"constraints":return n.length<2&&n.push({}),n[1];default:return q(e)}})}function ge(t,n,a,e){return e.map(e=>{switch(e){case"id":return(O.get(t)||{}).id;case"data":return(O.get(t)||{}).state;case"session":return a[0];case"context":return n;case"connection":return t;default:return q(e)}})}function ye(t,n,a,e){return e.map(e=>{switch(e){case"id":return(O.get(t)||{}).id;case"data":return(O.get(t)||{}).state;case"context":return n;case"candidate":return a[0];case"connection":return t;default:return q(e)}})}function be(t,n,a,r,s,e){return e.map(e=>{switch(e){case"id":return(O.get(t)||{}).id;case"data":return(O.get(t)||{}).state;case"type":return n;case"context":return a;case"args":return r;case"channel":return s;case"connection":return t;default:return q(e)}})}async function S(e,t,n,a,r){if(C.enable&&"method"==t&&"preconstruct"==n&&({params:s,process:o}=C,o&&(a.length<1&&a.push({}),void 0!==(o=y(o,ve(e,a,s)))&&(a[0]=o))),T.enable&&"method"==t&&0<=["createOfferOnSuccess","createAnswerOnSuccess","setLocalDescription","setRemoteDescription"].indexOf(n)){const{params:d,process:l}=T;if(l){const u=ge(e,n,a,d);if(0<=d.indexOf("transform")){var s=d.indexOf("transform");try{var c=await import(p+"/../ext/sdp-transform.js");u[s]=c.default}catch(e){v.warn("failed to load sdp-transform",e),u[s]=void 0}}var o=await y(l,u,!0);void 0!==o&&(a[0]=o)}}if(_.enable&&("method"==t&&"addIceCandidate"==n||"event"==t&&"icecandidate"==n)&&({params:c,process:s}=_,s&&(o=ye(e,n,a,c),c=a[0]&&a[0].candidate,s=y(s,o),null!==c&&null===s?a.splice(0,a.length):void 0!==s&&c&&c!=s.candidate&&(a[0]=new RTCIceCandidate({candidate:s.candidate,sdpMid:a[0].sdpMid,sdpMLineIndex:a[0].sdpMLineIndex,usernameFragment:a[0].usernameFragment})))),j.enable&&"event"==t&&"track"==n){var{params:o,process:c}=j;if(c){var{stream:s,track:i}=a[0],s=E({stream:s,context:"ontrack",track:i},o);j.calling+=1;let e;try{e=y(c,s)}finally{--j.calling}e&&(e.track||e.stream?a[0]=e:a.splice(0,1))}}D.enable&&("method"==t&&"createDataChannel"==n||"event"==t&&"datachannel"==n||"RTCDataChannel.method"==t||"RTCDataChannel.event"==t)&&({params:i,process:o}=D,o&&y(o,be(e,t,n,a,r,i)))}m&&r("datachannel",[]).then(e=>{"object"==typeof e&&e.datachannel?me(e.datachannel):D.enable=!1});const R={enable:void 0,params:null,process:null,pending:[],events:[]};function we(e){var{params:e,process:t}=g(e);t?(R.enable=!0,R.params=e,R.process=t):R.enable=!1}m&&r("websocket",[]).then(e=>{"object"==typeof e&&e.websocket?we(e.websocket):R.enable=!1,R.pending.forEach(e=>{const t=e.attach;delete e.attach,t()}),R.pending.splice(0,R.pending.length)});const P=new Set,L=new Map;function ke(e,r,o){return new Proxy(e,{construct(n,a){if(!1===R.enable)return new n(...a);const c={sets:[]},t=async()=>{var e={id:r+ ++oe,state:{}},t=("function"==typeof o.preconstruct&&await o.preconstruct(e,a),new n(...a));P.add(t),L.set(t,e),"function"==typeof o.construct&&await o.construct(t,a),c.obj=t};return void 0!==R.enable?t().then(()=>{const e=c["sets"];delete c.sets,(e||[]).forEach(({prop:e,value:t})=>{Reflect.set(c.obj,e,t)})}):(c.attach=()=>{const e=c["sets"];delete c.sets,t().then(()=>{(e||[]).forEach(({prop:e,value:t})=>{Reflect.set(c.obj,e,t)})})},R.pending.push(c)),new Proxy(c,{set(e,t,n){if(c.obj){const e=c.obj;return Reflect.set(e,t,n)}return c.sets.push({prop:t,value:n}),n},get(e,r){if(c.obj){const e=c.obj,s=c.obj;return"function"==typeof e[r]?new Proxy(e[r],{apply(e,t,n){if("function"!=typeof o[r])return Reflect.apply(e,s,n);if("close"!=r)return o[r](s,n);{const a=o[r](s,n);if(!("object"==typeof a&&a instanceof Promise))return setTimeout(()=>{P.delete(s),L.delete(s)}),a;a.then(()=>{setTimeout(()=>{P.delete(s),L.delete(s)})})}}}):Reflect.get(e,r)}v.warn("getter undefined for",r)}})}})}function je(t,n,a,r,e){return e.map(e=>{switch(e){case"data":return("method"==n&&"preconstruct"==a?t:L.get(t)||{}).state;case"type":return n;case"context":return a;case"args":return r;case"socket":return t;default:return q(e)}})}async function I(e,t,n,a){if("method"==t&&"preconstruct"==n){var{params:r,process:s}=R;if(s){const c=je(e,t,n,a,r);r=await y(s,c);r&&(c[0]=r)}}else"method"!=t&&"event"!=t||({params:s,process:r}=R,r&&await y(r,je(e,t,n,a,s),!0))}window.WebSocket=ke(window.WebSocket,"ws",{preconstruct:async function(e,t){await I(e,"method","preconstruct",t)},construct:async function(i,e){await I(i,"method","construct",e),["close","error","open","message"].forEach(o=>{i.addEventListener(o,async t=>{var e=R.events.indexOf(t);if(e<0){t.preventDefault(),t.stopImmediatePropagation();var n,a,r,s,c=[t];if(await I(i,"event",t.type,c),c.length){let e;"message"==o?({data:c,origin:n,lastEventId:a,source:r,ports:s}=t,e=new MessageEvent("message",{data:c,origin:n,lastEventId:a,source:r,ports:s})):(e=new Event(o),"error"==o&&t.error&&(e.error=t.error)),R.events.push(e),i.dispatchEvent(e)}}else R.events.splice(e,1)})})},send:async function(e,t){return await I(e,"method","send",t),e.send(...t)},close:async function(e,t){return await I(e,"method","close",t),e.close(...t)}});const M={enable:void 0,params:null,process:null,pending:[]};function Ee(e){var{params:e,process:t}=g(e);t?(M.enable=!0,M.params=e,M.process=t):M.enable=!1}function A(t,n,a,r,e,s,c){return e.map(e=>{switch(e){case"data":return r;case"context":return t;case"args":return n;case"xhr":return a;case"resolve":return s;case"reject":return c;default:return q(e)}})}function Oe(e){let t;switch(e){case"videocapture":t=l;break;case"screencapture":t=u;break;case"devicelist":t=n;break;case"mediastream":t=j;break;case"usermedia":t=f;break;case"mediacodec":t=T;break;case"mediaconnect":t=C;break;case"medianetwork":t=_;break;case"datachannel":t=D;break;case"websocket":t=R}if(t)return t.enable?t.process:null}function q(e){switch(e){case"global":return V;case"respath":return p;case"console":return v;case"location":{const t="hash, host, hostname, href, origin, pathname, port, protocol, search".split(", ");return Object.keys(window.location).filter(e=>0<=t.indexOf(e)).reduce((e,t)=>(e[t]=window.location[t],e),{})}default:return}}m&&r("webrequest",[]).then(e=>{"object"==typeof e&&e.webrequest?Ee(e.webrequest):M.enable=!1;const t=M.pending.slice();0<t.length&&(M.pending.splice(0,M.pending.length),t.forEach(e=>{if("fetch"==e.type){var{args:t,resolve:n,reject:a}=e;fetch(...t).then(n).catch(a)}else if("open"==e.type||"send"==e.type){const{type:r,xhr:s,args:c}=e;s[r](...c)}}))}),M.fetch=window.fetch,window.fetch=(...n)=>{if(!1!==M.enable)return new Promise((s,c)=>{if(void 0===M.enable)M.pending.push({type:"fetch",args:n,resolve:s,reject:c});else{const t=M.fetch,{params:o,process:i}=M;if(M.enable&&i){const d={};let r=!1;const l=e=>{r=!0,s(e)},u=e=>{r=!0,c(e)};var e=A("fetch",n,void 0,d,o,l,u);y(i,e,!0).then(()=>{r?v.log("fetch already responded, not calling"):0<n.length?t(...n).then(t=>{if(r)v.log("fetchresponse already responded",t);else{const n=t.clone(),a=[n];var e=A("fetchresponse",a,void 0,d,o,l,u);y(i,e,!0).then(e=>{r?v.log("fetchresponse already responded"):0<a.length?e?s(e):a[0]===n?s(t):s(a[0]):v.log("suppressing fetch response")}).catch(e=>{v.log("fetchresponse on error",e),c(e)})}}).catch(t=>{if(r)v.log("fetcherror already responded",t);else{const n=[t];var e=A("fetcherror",n,void 0,d,o,l,u);y(i,e,!0).then(e=>{r?v.log("fetcherror already responded"):0<n.length?e?s(e):n[0]===t?c(t):c(n[0]):v.log("suppressing fetch error")}).catch(e=>{v.log("fetcherror on error",e),c(e)})}}):v.log("suppressing fetch")}).catch(e=>{v.log("suppressing fetch on error",e),c(e)})}else t(...n).then(e=>s(e)).catch(e=>c(e))}});{const e=M.fetch;return e(...n)}},M.open=XMLHttpRequest.prototype.open,M.send=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.open=function(...t){if(void 0===M.enable)M.pending.push({type:"open",xhr:this,args:t});else{const{open:n,send:a,params:r,process:s}=M;if(M.enable&&s){let e=this._data;e=e||(this._data={state:{}}),y(s,A("open",t,this,e.state,r),!0).catch(e=>{v.log("open on error",e)}).finally(()=>{0<t.length?(e.opened=!0,n.apply(this,t),e.pending_send&&a.apply(this,e.pending_send)):v.log("suppressing open")})}else n.apply(this,t)}},XMLHttpRequest.prototype.send=function(...t){if(void 0===M.enable)M.pending.push({type:"send",xhr:this,args:t});else{const{send:s,params:c,process:o}=M;if(M.enable&&o){let n=this._data,e=(n=n||(this._data={state:{}}),!1);const i=()=>{e||(e=!0,["response","responseText","status","readyState"].forEach(e=>{let t=this[e];Object.defineProperty(this,e,{get:function(){return t},set:function(e){t=e},enumerable:!0,configurable:!0})}))},d=this.onreadystatechange;let a=!1;const l=e=>{a||(i(),a=!0,this.status=200,e&&(this.response=this.responseText=e),this.readyState=4,d&&d.apply(this,[]))},u=e=>{a||(i(),a=!0,this.status=0,e&&(this.response=this.responseText=e),this.readyState=4,d&&d.apply(this,[]))};this.onreadystatechange=function(...e){var t;4==this.readyState?(i(),t=A("readystatechange",e,this,n.state,c,l,u),y(o,t,!0).catch(e=>{v.log("response on error",e)}).finally(()=>{!a&&d&&d.apply(this,e)})):!a&&d&&d.apply(this,e)};var r=A("send",t=t.length?t:[null],this,n.state,c,l,u);y(o,r,!0).then(()=>{a?v.log("send already responded"):0<t.length?n.opened?s.apply(this,t):n.pending_send=t:v.log("suppressing send")}).catch(e=>{v.log("send on error",e),a?v.log("send error already responded"):(this.status=0,this.responseText=e,this.readyState=4,d&&d.apply(this,[]),this.onerror&&this.onerror(new ProgressEvent("error")))})}else s.apply(this,t)}},m||(window._rtchelper_setprocess=a)};if(document.querySelector("html").hasAttribute("rtchelper-respath")){const t=document.querySelector("html").getAttribute("rtchelper-respath"),n=document.querySelector("html").getAttribute("rtchelper-nonce"),a=(document.querySelector("html").removeAttribute("rtchelper-nonce"),document.querySelector("html").removeAttribute("rtchelper-respath"),document.querySelector("html").setAttribute("rtchelper",""),window.BroadcastChannel?new BroadcastChannel(n):window);e(a,n,t,!0)}window._rtchelper_content=e})();
