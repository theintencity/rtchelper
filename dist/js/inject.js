(window._rtchelper||document.querySelector("html").hasAttribute("rtchelper")?function(){}:function(){const e=function(v,s,p,N){const t=e=>(""+Math.random()).substring(2,e||8),$={},g={log:window.console.log,debug:window.console.debug,info:window.console.info,warn:window.console.warn,error:window.console.error},F={get:(e,t)=>{let n=B(e);return n=void 0===n?t:n},set:(e,t)=>{X(e,t)},on:(e,t)=>{G(e,t)},off:(e,t)=>{K(e,t)}},V=N?{on:(e,t)=>{jt(e,t)},off:(e,t)=>{Ot(e,t)}}:void 0;let z="";v&&v.addEventListener("message",t=>{if(!(t.source&&t.source!==window||t.data.nonce!=s||"from"!=t.data.dir))if(t.data.method)"setprocess"==t.data.method?W(t.data.type,t.data.body):"statsopen"==t.data.method?Ke():"setstrict"==t.data.method?z=t.data.value:"setsavestats"==t.data.method?We(t.data.value):"onusercontrols"==t.data.method?Y(t.data.data,t.data.sender):"oncpuperformance"==t.data.method&&xt(t.data.data,t.data.sender);else if(t.data.request)J(t.data.request).then(e=>{e={id:t.data.id,dir:"to",nonce:s,resolve:e};v.postMessage(e,"*")}).catch(e=>{e={id:t.data.id,dir:"to",nonce:s,reject:""+e};v.postMessage(e,"*")});else{const n=$[t.data.id];var e;n?(delete $[t.data.id],(e=t.data.response).reject?n.reject(e.reject):n.resolve(e.resolve)):g.warn("promise is already fullfilled: "+t.data.id)}});const H=["videocapture","screencapture","devicelist","mediarecord","mediadisplay","mediastream","usermedia","mediacodec","mediaconnect","medianetwork","mediastats","datachannel","websocket","webrequest","pagesecurity","cpuperformance","usercontrols"];function W(e,t){if(0<=H.indexOf(e))switch(e){case"videocapture":return se(t);case"screencapture":return ce(t);case"devicelist":return ie(t);case"mediarecord":return xe(t);case"mediadisplay":return je(t);case"mediastream":return Le(t);case"usermedia":return oe(t);case"mediacodec":return st(t);case"mediaconnect":return ct(t);case"medianetwork":return ot(t);case"mediastats":return it(t);case"datachannel":return dt(t);case"websocket":return ht(t);case"webrequest":return kt(t);case"cpuperformance":return Et(t);case"usercontrols":return U(t)}}function J(n){return new Promise((e,t)=>{switch(n.function){case"start_mediarecord":e(De(...n.args));break;case"stop_mediarecord":e(Pe(...n.args));break;case"get_mediarecord":e(Re(...n.args));break;case"clear_mediarecord":e(Ie(...n.args));break;default:t("invalid function "+n.function)}})}function b(a,e){if(v){const n=t(),r={function:a,args:e};return v.postMessage({nonce:s,dir:"to",id:n,request:r}),new Promise((e,t)=>{$[n]={request:r,resolve:e,reject:t}})}return new Promise((e,t)=>{const n=Tt(a);obj={},n&&(obj[a]=n.toString()),e(obj)})}const r={enable:!1,variables:null,subscribes:{}};function U(e){e&&e.variables&&e.variables.length?(r.enable=!0,r.variables=e.variables):(r.enable=!1,r.variables=null)}function B(t){var e=(r.variables||[]).find(e=>e.varname==t);return e&&e.value}function X(e,t){b("set_usercontrols",[{varname:e,value:t}])}function G(e,t){t&&"function"==typeof t?(r.subscribes[e]||(r.subscribes[e]=[]),r.subscribes[e].indexOf(t)<0&&(r.subscribes[e].push(t),1===r.subscribes[e].length&&b("on_usercontrols",[{varname:e,value:!0}]))):void 0===t&&K(e)}function K(e,t){var n=r.subscribes[e];let a=!1;void 0===t?n&&(a=!0,delete r.subscribes[e]):0<=(n=(r.subscribes[e]||[]).indexOf(t))&&(r.subscribes[e].splice(n,1),r.subscribes[e].length||(a=!0,delete r.subscribes[e])),a&&b("on_usercontrols",[{varname:e,value:!1}])}function Y(n,e){const a=n["varname"],t=r.subscribes[a];t?t.forEach(e=>{try{const t=e(n.value,n.old);"object"==typeof t&&t instanceof Promise&&t.catch(e=>{g.warn("promise error in on "+a+" handler",e)})}catch(e){g.warn("exception in on "+a+" handler",e)}}):e||b("on_usercontrols",[{varname:a,value:!1}])}function Z(r,s){return new Promise((a,e)=>{r.pending_upload?e("already pending upload"):(r.pending_upload=!0,document.addEventListener("click",function e(t){document.removeEventListener("click",e);{const n=document.createElement("input");n.setAttribute("type","file"),n.setAttribute("accept",s||"image/*, video/*"),n.setAttribute("multiple",""),n.onchange=()=>{delete r.pending_upload,a(n.files)};try{n.click()}catch(e){g.warn("failed to click on file input")}return}}))})}function Q(r,s,c){return new Promise((e,t)=>{if(r.pending_segment)t("already pending segment");else{if(r.pending_segment={resolve:e,reject:t},!r.segment_loaded){r.segment_loaded=!0;const n=()=>{const e=r.segmentation=new SelfieSegmentation({locateFile:e=>"local"==c?p+"/../ext/selfie_segmentation-0.1.1675465747/"+e:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1.1675465747/"+e});var t;e.setOptions({modelSelection:1}),e.onResults(e=>{if(r.pending_segment){const t=r.pending_segment["resolve"];delete r.pending_segment,t([e.segmentationMask,e.image])}}),r.pending_segment&&r.pending_segment.waiting&&(t=r.pending_segment.waiting,delete r.pending_segment.waiting,r.segmentation.send({image:t}).catch(e=>g.error(e)))};if(document.querySelector("script#virtualbackground"))r.segmentation&&r.segmentation.close(),n();else{const a=document.createElement("script");a.id="virtualbackground",a.setAttribute("crossorigin","anonymous"),a.setAttribute("src","local"==c?p+"/../ext/selfie_segmentation-0.1.1675465747/selfie_segmentation.js":"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1.1675465747/selfie_segmentation.js"),a.setAttribute("integrity","sha384-J/3LshwuX+2viPOY3En4QiZvdvlffDhZYH5MsMuLGdwcoGcYSA7EV1jXFsys0gIb"),a.onload=()=>{n()},document.head.appendChild(a)}}e=s.videoWidth||s.naturalWidth||s.width,t=s.videoHeight||s.naturalHeight||s.height;if(e&&t)r.segmentation?r.segmentation.send({image:s}).catch(e=>g.error(e)):r.pending_segment.waiting=s;else{const{resolve:e,reject:t}=r.pending_segment;delete r.pending_segment,t("invalid picture size")}}})}function ee(r,s,c){return new Promise((e,t)=>{if(r.pending_facedetect)t("already pending facedetect");else{if(r.pending_facedetect={resolve:e,reject:t},!r.facedetect_loaded){r.facedetect_loaded=!0;const n=()=>{const e=r.facedetect=new FaceDetection({locateFile:e=>"local"==c?p+"/../ext/face_detection-0.0/"+e:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.0/"+e});var t;e.setOptions({modelSelection:0,minDetectionConfidence:.5}),e.onResults(e=>{if(r.pending_facedetect){const t=r.pending_facedetect["resolve"];delete r.pending_facedetect,t([e.detections,e.image])}}),r.pending_facedetect&&r.pending_facedetect.waiting&&(t=r.pending_facedetect.waiting,delete r.pending_facedetect.waiting,r.facedetect.send({image:t}).catch(e=>{}))};if(document.querySelector("script#facedetect"))r.facedetect&&r.facedetect.close(),n();else{const a=document.createElement("script");a.id="facedetect",a.setAttribute("crossorigin","anonymous"),a.setAttribute("src","local"==c?p+"/../ext/face_detection-0.0/face_detection.js":"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.0/face_detection.js"),a.setAttribute("integrity","sha384-e6Te8CFt8ibDe9tEF5sw/QG3B+dk9WGZJH8UnyrJzVgdglARK03Ymw/J6RUI7yzA"),a.onload=()=>{n()},document.head.appendChild(a)}}e=s.videoWidth||s.naturalWidth||s.width,t=s.videoHeight||s.naturalHeight||s.height;if(e&&t)r.facedetect?r.facedetect.send({image:s}).catch(e=>{}):r.pending_facedetect.waiting=s;else{const{resolve:e,reject:t}=r.pending_facedetect;delete r.pending_facedetect,t("invalid picture size")}}})}v&&b("usercontrols",[]).then(e=>{"object"==typeof e&&e.usercontrols?U(e.usercontrols):r.enable=!1});const te={};function w(e){if(!e)return{params:null,process:null};var t=e.match(/^(async\s+)?function\s*(\w+\s*)?\(([^\)]*)\)\s*\{([\s\S]*)\}\s*$/);if(!t)return g.error("failed to match as valid function",e),{params:null,process:null};let n=t[3],a=t[4];n=n.split(",").map(e=>e.trim()).filter(e=>!!e);let r;return r=t[1]?(z?re:ae)(n,a,!0):(z?re:ae)(n,a),{params:n,process:r,is_async:!!t[1]}}function y(a,r,e){if("single"==e){if(!a.pending)return a.pending=!0,new Promise((t,n)=>{try{const e=a.apply(null,r);"object"==typeof e&&e instanceof Promise?e.then(e=>{delete a.pending,t(e)}).catch(e=>{delete a.pending,c("promise rejected:",a,e),n("promise failed")}):(delete a.pending,t(e))}catch(e){c("error in function:",a,e),n("error in function: "+e.message)}})}else{if(e)return new Promise((t,n)=>{try{const e=a.apply(null,r);"object"==typeof e&&e instanceof Promise?e.then(e=>{t(e)}).catch(e=>{c("promise rejected:",a,e),n(e)}):t(e)}catch(e){c("error in function:",a,e),n(e)}});try{return a.apply(null,r)}catch(e){throw c("error in function:",a,e),new Error("error in function: "+e.message)}}}function c(e,c,t){if(t&&t.stack&&"string"==typeof t.stack){let e=t.stack.split("\n");var n=e.findIndex(e=>!!e.match(/^\s*at (Object\.)?eval\b/));const a=e[n];e=e.slice(0,n+1),a.match(/:(\d+):(\d+)\)$/)&&(e[e.length-1]=e[e.length-1].replace(/\bat (Object\.)?eval\b/,"at function"),t.stack=e.map(e=>e.replace(/\(eval at (<anonymous>|regular_function|\w+) \(.*\), /,"(").replace(/^(.*:)(\d+)(:\d+\))$/,(e,t,n,a,r,s)=>t+(n-c.lineOffset+1)+a)).join("\n"))}g.error(e,t)}const ne=Object.getPrototypeOf(async function(){}).constructor;let o=null;function ae(e,t,n){let a;if(!o)try{a=new(n?ne:Function)(...e,t)}catch(e){if(!(e instanceof EvalError||e?.message?.match(/trusted/i)))throw e;o||(g.log("creating dummy script policy"),o=trustedTypes.createPolicy("test",{createScript:(e,...t)=>{return`(${e?"async ":""}function anonymous(${t.slice(0,-1).join(",")}) { ${t.pop().toString()} })`}}))}return(a=o?(window||self).eval(o.createScript(n,...e,t)):a).toString=()=>(n?"async ":"")+`function(${e.join(",")}) {
${t}
}`,a.lineOffset=3,a}function re(e,t,n){var a=["eval","Object","Number","String","Boolean","RegExp","JSON","Date","Math","console","Infinity","Array","Set","Map","NaN","Blob","URL","screen","parseInt","parseFloat","Error","Promise","fetch","FileReader","setTimeout","clearTimeout"],r=["fn","fnText","forbiddenKeys","exceptionKeys","empty","oForbiddenKeys"],s=Object.create(null),c=Object.create(null);Object.freeze(c),r.forEach(function(e){s[e]=null}),[this,self].forEach(function(e){Object.getOwnPropertyNames(e).forEach(function(e){e.match(/^[\$\w]+$/)&&!e.match(/^\d+$/)&&(s[e]=null)})}),a.forEach(function(e){delete s[e]});const o=t,i=(t=t.replace(/\beval\b/g,"eval_").replace(/\bimport\b/g,"import_"),t=['"use strict";',"var "+Object.keys(s).join(", ")+";","{",t,"}"].join("\n"),{createElement:function(e){if("img"==e||"video"==e)return document.createElement(e);throw new Error(`forbidden: document.createElement("${e}")`)}}),d=(Object.freeze(i),{get userAgent(){return navigator.userAgent},get userAgentData(){return navigator.userAgentData},get platform(){return navigator.platform}}),l=(Object.freeze(d),async()=>Promise.reject("forbidden: import")),u=()=>{throw new Error("forbidden: eval")};var p=function(){with(c)return new(n?ne:Function)(["self","window","document","navigator","import_","eval_",...e],t)}();const f=function(...e){return p.call(Object.create(null),c,c,i,d,l,u,...e)};return f.toString=()=>(n?"async ":"")+`function(${e.join(",")}) {
${o}
}`,f.lineOffset=6,f}const a={enable:!1,params:null,process:null,states:[]},i={enable:!1,params:null,process:null,states:[]},d={enable:!1,params:null,process:null};function se(t){if(!v){var{params:e,process:n}=w(t);if(!n)return void(a.enable=!1);a.enable=!0,a.params=e,a.process=n}a.states.forEach(e=>{le("videocapture",e,t)})}function ce(t){if(!v){var{params:e,process:n}=w(t);if(!n)return void(i.enable=!1);i.enable=!0,i.params=e,i.process=n}i.states.forEach(e=>{le("screencapture",e,t)})}function oe(t){if(!v){var{params:e,process:n}=w(t);if(!n)return void(d.enable=!1);d.enable=!0,d.params=e,d.process=n}a.states.forEach(e=>{ye(e,t)})}const n={enable:!1,params:null,process:null};function ie(e){var t;v||({params:e,process:t}=w(e),t?(n.enable=!0,n.params=e,n.process=t):n.enable=!1)}const k=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices),de=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices),l=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);function le(e,t,n){const{params:a,process:r}=w(n);r&&(t.args=ue(e,t,a),t.process=r,t.cleanup=a.indexOf("cleanup"))}function ue(e,n,t){const a=n.args=t.map(e=>{switch(e){case"canvas":return n.canvas;case"data":return n.data;case"upload":return Z;case"segment":return Q;case"facedetect":return ee;case"cleanup":return;default:return L(e)}});let r=t.indexOf("video"),s=(0<=r?(n.video||pe(e,n),a[r]=n.video):n.video&&fe(n),0<=(r=t.indexOf("videos"))?(n.videos||ve(n),a[r]=n.videos):n.videos&&ge(n),t.map((e,t)=>[e,t]).filter(e=>e[0].match(/^screen\d?$/))),c=(s.forEach(([e,t])=>{n[e]||me(n,e),a[t]=n[e]}),Object.keys(n).filter(e=>e.match(/^screen\d?$/)));return c.sort().reverse().forEach(t=>{s.findIndex(e=>e[0]==t)<0&&he(n,t)}),a}function pe(e,t){let n=t.video=null;const a=Object.assign("screencapture"==e?{video:!0}:{},t.constraints1||t.constraints);delete a.audio,(n=t.video=document.createElement("video")).autoplay=!0,a.video&&k(a).then(e=>{(n.srcObject=e)&&(t.track._attached||(t.track._attached=[]),t.track._attached.push(e.getVideoTracks()[0]))}).catch(e=>{g.error("failed to get user media",e)})}function fe(e){if(e.video){const n=e.video.srcObject;if(e.video.srcObject){e.video.srcObject=null;const a=n.getVideoTracks()[0];var t=(e.track._attached||[]).findIndex(e=>e===a);0<=t&&(e.track._attached.splice(t,0),a.stop())}e.video=null}}function me(t,e){const n=t[e]=document.createElement("video");n.autoplay=!0,de({frameRate:5}).then(e=>{n.srcObject=e,t.track._attached||(t.track._attached=[]),t.track._attached.push(e.getVideoTracks()[0]),e.oninactive=e=>{n.videoWidth=0,n.videoHeight=0}}).catch(e=>{g.error("failed to get display media",e)})}function he(e,t){if(e[t]){const a=e[t].srcObject;if(e[t].srcObject){e[t].srcObject=null;const r=a.getVideoTracks()[0];var n=(e.track._attached||[]).findIndex(e=>e===r);0<=n&&(e.track._attached.splice(n,0),r.stop())}e[t]=null}}function ve(a){let r=a.videos=[];const s=Object.assign({},a.constraints1||a.constraints);delete s.audio,s.video&&"object"==typeof s.video&&s.video.deviceId&&delete s.video.deviceId,l().then(e=>{const t=[];e.forEach(e=>{"videoinput"==e.kind&&t.push(e.deviceId)}),a.track._attached||(a.track._attached=[]),t.forEach((t,e)=>{const n=Object.assign({},s);"object"!=typeof n.video&&(n.video={}),n.video.deviceId={exact:t},k(n).then(e=>{const t=document.createElement("video");t.autoplay=!0,t.srcObject=e,a.track._attached.push(e.getVideoTracks()[0]),r.push(t)}).catch(e=>g.error("failed to get webcam: "+t,e))})}).catch(e=>g.error("enumerateDevices",e))}function ge(a){a.videos&&(a.videos.forEach(e=>{const t=e.srcObject;if(e.srcObject){e.srcObject=null;const n=t.getVideoTracks()[0];e=(a.track._attached||[]).findIndex(e=>e===n);0<=e&&(a.track._attached.splice(e,0),n.stop())}}),a.videos=null)}async function be(e,t,n){var{params:e,process:a}=w(e.usermedia);return t=a?(t=await y(a,we({context:n,constraints:a=t&&JSON.parse(JSON.stringify(t))},e),!0))||a:t}function we(e,t){const{context:n,constraints:a}=e;return t.map(e=>{switch(e){case"constraints":return a;case"context":return n;default:return L(e)}})}function ye(e,t){e.usermedia=t,e.track&&e.constraints&&e.constraints.video&&e.track.applyConstraints(e.constraints.video).catch(e=>{g.log("error in applyConstraints",e)})}async function ke(t,e,n,s){var c=await b(n,[]),o=await b("usermedia",[]),a=await b("mediastream",[]);const i={constraints:t};"object"==typeof o&&o.usermedia&&(i.usermedia=o.usermedia,t=i.constraints1=await be(i,t,e));let d=null;if("object"==typeof c&&c[n]){const l=document.createElement("canvas");let a="screencapture"==n?{width:1280,height:960,frameRate:5}:{width:320,height:240,frameRate:15};t&&"object"==typeof t.video&&["width","height","frameRate"].forEach(e=>{"number"==typeof t.video[e]?a[e]=t.video[e]:"object"==typeof t.video[e]&&(a[e]=t.video[e].exact||t.video[e].max||a[e])}),l.width=a.width,l.height=a.height;l.getContext("2d");const u=l.captureStream(),p=(u._rtchelp=!0,u.getVideoTracks()[0]),f=Object.assign({},t||{});delete f.video;let r=null;p.applyConstraints.bind(p);p.applyConstraints=async function(n){if("object"==typeof i.constraints&&i.constraints.video!==n&&(i.constraints.video=n),i.usermedia){var e=await be(i,{video:n},"applyConstraints");if(!(n=e&&e.video))return;i.constraints1&&(i.constraints1.video=n)}e=a.frameRate;if(["width","height","frameRate"].forEach(e=>{"number"==typeof n[e]?a[e]=n[e]:"object"==typeof n[e]&&(a[e]=n[e].exact||n[e].max||a[e])}),l.width=a.width,l.height=a.height,e!=a.frameRate&&(r&&(clearInterval(r),r=null),r=setInterval(async()=>{var{process:e,args:t}=i;if(e&&t)try{await y(e,t,"single")}catch(e){}},1e3/a.frameRate)),i.video&&i.video.srcObject){const t=i.video.srcObject.getVideoTracks()[0];t&&"live"==t.readyState&&t.applyConstraints(n).catch(e=>{g.error("failed to applyConstraints",e)})}else i.videos&&0<i.videos.length&&i.videos.filter(e=>!!e.srcObject).forEach(e=>{const t=e.srcObject.getVideoTracks()[0];t&&"live"==t.readyState&&t.applyConstraints(n).catch(e=>{g.error("failed to applyConstraints",e)})})};o=Date.now(),o=(Object.assign(i,{data:{start:o},canvas:l,track:p,video:null,process:null,args:[]}),s.states.push(i),le(n,i,c[n]),async()=>{var{process:e,args:t}=i;if(e&&t)try{await y(e,t,"single")}catch(e){}});r=setInterval(o,1e3/a.frameRate),a.frameRate<=5&&setTimeout(o,0);const m=async()=>{if(0<=i.cleanup){const{process:e,args:t}=i;if(e&&t)try{t[i.cleanup]=!0,await y(e,t,!0)}catch(e){}}};if(p.addEventListener("ended",e=>{r&&(clearInterval(r),r=null),e.currentTarget._attached&&(e.currentTarget._attached.forEach(e=>{e.stop()}),e.currentTarget._attached=null),m().catch(e=>{})}),p.stop=()=>{r&&(clearInterval(r),r=null),p._attached&&(p._attached.forEach(e=>{e.stop()}),p._attached=null),m().catch(e=>{})},f.audio)try{const h=await k(f);u.addTrack(h.getAudioTracks()[0]),"usermedia"==_.mode&&Ae(h)}catch(e){}v&&v.postMessage({type:e,constraints:t},"*"),d=Promise.resolve(u)}else"usermedia"==_.mode?(d=await("screencapture"==n?de:k)(t),"usermedia"==_.mode&&d.getAudioTracks().length&&Ae(d)):d=("screencapture"==n?de:k)(t);if(!E.calling&&d&&"object"==typeof a&&a.mediastream){var{params:s,process:c}=w(a.mediastream);if(c){o=Ne({stream:d=await d,context:"screencapture"==n?"getDisplayMedia":"getUserMedia"},s);E.calling+=1;let e;try{e=await y(c,o,!0)}finally{--E.calling}e&&(d=e),d=Promise.resolve(d)}}return d}async function _e(e){return Promise.all(e.map(async e=>"devices"!==e?L(e)||Promise.resolve(void 0):l()))}navigator.mediaDevices.getUserMedia=e=>ke(e,"getUserMedia","videocapture",a),navigator.mediaDevices.getDisplayMedia=e=>ke(e,"getDisplayMedia","screencapture",i),navigator.mediaDevices.enumerateDevices=async e=>{var t,n=await b("devicelist",[]);return"object"==typeof n&&n.devicelist?({params:n,process:t}=w(n.devicelist),t?y(t,await _e(n),!0)||[]:l()):l()};const h=new Set,u=new Map;function Ee(e){if(u.has(e.currentTarget)){const t=u.get(e.currentTarget);t.state!=e.type&&(t.state=e.type,f.enable&&m(e.currentTarget,e.type),_.onvideoevent&&_.onvideoevent(e.currentTarget,e.type))}}window.addEventListener("load",()=>{const n=["playing","suspend","emptied","ended","error"],a=(t,e)=>{"VIDEO-IO"==t.nodeName&&(t=t.video),e?(n.forEach(e=>{t.removeEventListener(e,Ee)}),h.delete(t),u.delete(t),f.enable&&m(t,"removed"),_.onvideochange&&_.onvideochange(t,"remove")):h.has(t)||(u.set(t,{state:"idle"}),h.add(t),n.forEach(e=>{t.addEventListener(e,Ee)}),f.enable&&m(t,"added"),_.onvideochange&&_.onvideochange(t,"add"))};new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1==e.nodeType)if("VIDEO"==e.nodeName||"VIDEO-IO"==e.nodeName||"AUDIO"==e.nodeName)a(e);else{const t=[].slice.call(e.querySelectorAll("video, video-io, audio"));t.forEach(e=>a(e))}}),e.removedNodes.forEach(e=>{if(1==e.nodeType)if("VIDEO"==e.nodeName||"VIDEO-IO"==e.nodeName||"AUDIO"==e.nodeName)a(e,!0);else{const t=[].slice.call(e.querySelectorAll("video, video-io, audio"));t.forEach(e=>a(e,!0))}})})}).observe(document.querySelector("body"),{subtree:!0,childList:!0}),document.querySelectorAll("video, video-io, audio").forEach(e=>{a(e)})});const f={enable:!1,params:null,process:null,data:new Map};function je(e){var{params:e,process:t}=w(e);f.enable&&[...h.values()].forEach(e=>{m(e,"ignored")}),t?(f.enable=!0,f.params=e,f.process=t):(f.enable=!1,f.params=null,f.process=null),f.enable&&[...h.values()].forEach(e=>{m(e,"found")})}function m(e,t){const{params:n,process:a,data:r}=f;"added"!=t&&"found"!=t||r.set(e,{});var s=Oe({video:e,state:t},n);a&&y(a,s,!0).catch(e=>{}),"removed"!=t&&"ignored"!=t||r.delete(e)}function Oe(e,t){const n=f["data"],{video:a,state:r}=e;return(t||[]).map(e=>{switch(e){case"video":return a;case"data":return Object.assign(n.get(a)||{},{state:r});case"getstyle":return Se;case"open":return Te;default:return L(e)}})}v&&b("mediadisplay",[]).then(e=>{"object"==typeof e&&e.mediadisplay?je(e.mediadisplay):f.enable=!1});const _={enable:!1,preview:{width:320,height:240,right:10,bottom:54},mode:null,usermedia:[],mediaconnect:[],state:null};function xe(e){const{params:t,process:n}=w(e);n&&(_.params=t,_.process=n,_.mode=(t||[]).find(e=>"mediaconnect"==e||"usermedia"==e||"noaudio"==e),_.cleanup=t.indexOf("cleanup"))}function Se(e){return h.has(e)?window.getComputedStyle(e):(g.log("preventing access to getstyle (window.getComputedStyle) on non-video element"),{})}function Te(...e){return 2<=e.length&&"blob:"==e[0].substring(0,5)&&"_blank"==e[1]?window.open(...e):(g.log("preventing access to open (window.open) unless opening a blob URL on _blank tab."),null)}function Ce(e,t){const n=e["canvas"];return(t||[]).map(e=>{switch(e){case"canvas":return n;case"videos":return[...h.values()].filter(e=>"VIDEO"==e.nodeName);case"states":return[...h.values()].filter(e=>"VIDEO"==e.nodeName).map(e=>{e=u.get(e);return e&&e.state});case"data":return _.state;case"getstyle":return Se;case"cleanup":return;default:return L(e)}})}function De(t){_.enable||(_.enable=!0,_.crossorigin=!!t,b("mediarecord",[]).then(e=>{if("object"!=typeof e||!e.mediarecord)return Pe(),void(_.enable=!1);xe(e.mediarecord),Me(t)}))}function Me(n){const e=_.stream=new MediaStream,a=_.canvas=document.createElement("canvas");a.width=640,a.height=480;var t=async()=>{var e,t=_.process;t&&(e=Ce({canvas:a},_.params),t&&e&&(await y(t,e,!0),n&&a.width!==_.width&&a.height!==_.height&&(_.width=a.width,_.height=a.height,t=Math.min(_.preview.width/a.width,_.preview.height/a.height),a.style.setProperty("transform",`scale(${t})`,"important"))))},r=(_.state={},t().catch(e=>{}),_.state.frameRate||15),s=_.state.mimeType||("noaudio"==_.mode?'video/webm; codecs="h264"':'video/webm; codecs="h264,opus"');if(!MediaRecorder.isTypeSupported(s))return g.warn("type not supported",s),Pe(),void(_.enable=!1);_.start=Date.now();a.getContext("2d");const c=_.canvas_stream=a.captureStream(r);if(e.addTrack(c.getVideoTracks()[0]),"noaudio"!=_.mode){const d=_.audio=new AudioContext,l=_.dest=d.createMediaStreamDestination(),u=_.buffer=d.createBufferSource();if(u.connect(l),e.addTrack(l.stream.getAudioTracks()[0]),"mediaconnect"!=_.mode){const p=e=>{if(!e._stream_source&&e.srcObject&&e.srcObject.getAudioTracks().length){const t=e._stream_source=d.createMediaStreamSource(e.srcObject);m.push(t),t.connect(l)}},f=e=>{if(e._stream_source){const t=e._stream_source;delete e._stream_source,t.disconnect();e=m.indexOf(t);0<=e&&m.splice(e,1)}},m=_.sources=[];[...h.values()].forEach(e=>{p(e)}),_.onvideoevent=(e,t)=>{"playing"==t?p(e):"ended"!=t&&"emptied"!=t&&"suspend"!=t||f(e)},_.onvideochange=(e,t)=>{"add"==t?p(e):"remove"==t&&f(e)},"usermedia"==_.mode&&_.usermedia.forEach(e=>{Ae(e)})}else _.mediaconnect.forEach(e=>{qe("track",e)})}const o=_.chunks=[];var s={mimeType:s};const i=_.recorder=new MediaRecorder(e,s);i.ondataavailable=e=>{0<e.data.size&&o.push(e.data)},i.onerror=e=>{g.warn("recorder error",e,e.error)},i.start(),_.timer=setInterval(t,1e3/r),n?(s=window.top===window?{position:"fixed","z-index":"2147483647",right:_.preview.right+"px",bottom:_.preview.bottom+"px","box-sizing":"border-box",border:"none","box-shadow":"0 0 10px 1px black","transform-origin":"bottom right",transform:"scale(0.4)"}:{position:"fixed","z-index":"2147483647",right:_.preview.right+"px",top:_.preview.right+"px","box-sizing":"border-box",border:"none","box-shadow":"0 0 10px 1px black","transform-origin":"bottom top",transform:"scale(0.4)"},Object.entries(s).forEach(e=>a.style.setProperty(e[0],e[1],"important")),document.body.appendChild(a)):(window._rtchelper_stream=e,setTimeout(()=>{window._rtchelper_stream===e&&delete window._rtchelper_stream},2e3))}function Re(){var e,t;if(_.chunks&&0<_.chunks.length)return e=new Blob(_.chunks,{type:"video/webm"}),e=URL.createObjectURL(e),t=_.end-_.start,g.log("returning mediarecord",e,t),{bloburl:e,duration:t}}function Ie(){_.chunks=[]}function Pe(){if(_.enable){if(0<=_.cleanup){var{process:e,canvas:t,params:n}=_;if(e&&t){const a=Ce({canvas:t},n);a[_.cleanup]=!0,e&&a&&y(e,a,!0).catch(e=>{})}}_.enable=!1,delete _.onvideoevent,delete _.onvideochange,_.end=Date.now(),_.recorder&&("inactive"==_.recorder.state?g.warn("recorder is already stopped"):_.recorder.stop()),_.sources&&(_.sources.forEach(e=>e.disconnect()),_.sources.splice(0,_.sources.length)),_.buffer&&_.buffer.disconnect(),_.dest&&_.dest.disconnect(),_.audio&&_.audio.close(),_.stream&&([..._.stream.getVideoTracks()].forEach(e=>e.stop()),[..._.stream.getAudioTracks()].forEach(e=>e.stop())),_.timer&&clearInterval(_.timer),_.crossorigin&&(_.crossorigin=!1,_.canvas&&document.body.removeChild(_.canvas)),_.usermedia.length&&_.usermedia.splice(0,_.usermedia.length),_.mediaconnect.length&&_.mediaconnect.splice(0,_.mediaconnect.length),_.canvas=_.stream=_.recorder=_.timer=_.process=_.audio=_.dest=_.sources=_.buffer=_.canvas_stream=_.state=null}}function Ae(r){const{enable:e,usermedia:s}=_;if(s.indexOf(r)<0&&(s.push(r),r.getAudioTracks()[0].addEventListener("ended",e=>{var t=s.indexOf(r);if(0<=t&&s.splice(t,1),r._source){const n=r._source,a=(delete r._source,n.disconnect(),_)["sources"];t=a.indexOf(n);0<=t&&a.splice(t,1)}})),e){const{audio:t,sources:n,dest:a}=_,c=t.createMediaStreamSource(r);r._source=c,n.push(c),c.connect(a)}}function qe(e,r){if("audio"==r.kind){const{enable:n,mediaconnect:s}=_;if(("addTrack"==e||"track"==e)&&s.indexOf(r)<0?(s.push(r),r.addEventListener("ended",e=>{var t=s.indexOf(r);if(0<=t&&s.splice(t,1),r._source){const n=r._source,a=(delete r._source,n.disconnect(),_)["sources"];t=a.indexOf(n);0<=t&&a.splice(t,1)}})):"removeTrack"==e&&0<=(t=s.indexOf(r))&&s.splice(t,1),n){const{audio:a,sources:c,dest:o}=_;if("addTrack"==e||"track"==e){var t=new MediaStream([r]);const i=r._source=a.createMediaStreamSource(t);c.push(i),i.connect(o)}else if("removeTrack"==e&&r._source){const d=r._source;delete r._source,d.disconnect();t=c.indexOf(d);0<=t&&c.splice(t,1)}}}}const E={enable:!1,params:null,process:null,calling:0};function Le(e){var{params:e,process:t}=w(e);t?(E.enable=!0,E.params=e,E.process=t):(E.enable=!1,E.params=null,E.process=null)}function Ne(e,t){const{stream:n,context:a,track:r,source:s}=e;return(t||[]).map(e=>{switch(e){case"stream":return n;case"track":return r;case"source":return s;case"context":return a;default:return L(e)}})}function $e(t,n,a){let r=t.call(n,...a);if(!E.calling&&E.enable){var{params:t,process:a}=E,n=Ne({stream:r,context:"captureStream",source:n},t);E.calling+=1;let e;try{e=y(a,n)}finally{--E.calling}e&&(r=e)}return r}v&&b("mediastream",[]).then(e=>{"object"==typeof e&&e.mediastream?Le(e.mediastream):E.enable=!1}),E.captureStream=HTMLMediaElement.prototype.captureStream,E.captureStreamCanvas=HTMLCanvasElement.prototype.captureStream,HTMLMediaElement.prototype.captureStream=function(...e){return $e(E.captureStream,this,e)},HTMLCanvasElement.prototype.captureStream=function(...e){return $e(E.captureStreamCanvas,this,e)};let Fe=0;const Ve=new Set,j=new Map;function e(e,a,c){return new Proxy(e,{construct(e,t){var n={id:a+ ++Fe,state:{}};"function"==typeof c.preconstruct&&c.preconstruct(n,t);const s=new e(...t);return Ve.add(s),j.set(s,n),"function"==typeof c.construct&&c.construct(s,t),new Proxy(s,{set(e,t,n){return Reflect.set(e,t,n)},get(e,r){return"function"==typeof e[r]?new Proxy(e[r],{apply(e,t,n){var a;return"function"==typeof c[r]?"close"==r?(a=c[r](s,n),setTimeout(()=>{Ve.delete(s),j.delete(s)}),a):c[r](s,n):("getStats"!==r&&M(s,"method",r),Reflect.apply(e,s,n))}}):Reflect.get(e,r)}})}})}function ze(r,s){return"function"==typeof s.construct&&s.construct(r),new Proxy(r,{set(e,t,n){return Reflect.set(e,t,n)},get(e,a){return"function"==typeof e[a]?new Proxy(e[a],{apply(e,t,n){return"function"==typeof s[a]?s[a](r,n):Reflect.apply(e,r,n)}}):Reflect.get(e,a)}})}function O(r,s,e){return new Promise((n,a)=>{M(r,"method",s,e).then(()=>{"addIceCandidate"!=s||e.length?r[s](...e).then(e=>{const t=[e];M(r,"method",s+"OnSuccess",t).then(()=>{n(t[0])})}).catch(e=>{const t=[e];M(r,"method",s+"OnFailure",t).then(()=>{a(t[0])})}):n()})})}const He={url:"ws://localhost:9080/publish?sid={{sid}}",viewer:"http://localhost:9000/index.html?sid={{sid}}"},x=Object.assign({enable:!1,params:null,process:null,interval:1e4,ws:null,wsurl:null,retry:8e3,wstimer:null,sent:[],queue:[],maxsize:8e3,warned:!1,unloading:!1},He);function We(e){e=(e||"").split("\n").map(e=>e.trim()).filter(e=>!!e);Object.assign(x,e.length<2?He:{url:e[0],viewer:e[1]})}function Je(e,r){return ze(e,{construct:function(a){a.addEventListener("bufferedamountlow",e=>{M(r,"RTCDataChannel.event",e.type,[],a)}),a.addEventListener("close",e=>{M(r,"RTCDataChannel.event",e.type,[],a)}),a.addEventListener("error",e=>{if(!e._intercepted){var t=[{error:e.error}];if(M(r,"RTCDataChannel.event",e.type,t,a),1===t.length&&t[0].error===e.error||(e.preventDefault(),e.stopImmediatePropagation()),1===t.length&&t[0].error!==e.error){const n=new Event("error");Object.assign(n,{error:t[0].error}),n._intercepted=!0,a.dispatchEvent(n)}}}),a.addEventListener("message",e=>{if(!e._intercepted){var t=[{data:e.data}];if(M(r,"RTCDataChannel.event",e.type,t,a),1===t.length&&e.data===t[0].data||(e.preventDefault(),e.stopImmediatePropagation()),1===t.length&&e.data!==t[0].data){const n=new Event("message");Object.assign(n,{data:t[0].data}),n._intercepted=!0,a.dispatchEvent(n)}}}),a.addEventListener("open",e=>{M(r,"RTCDataChannel.event",e.type,[],a)})},close:function(e,t){return M(r,"RTCDataChannel.method","close",t,e),e.close(...t)},send:function(e,t){return M(r,"RTCDataChannel.method","send",t,e),e.send(...t)}})}function Ue(e,t){let n=0,a,r,s=[],c=[],o=e.length,i=t.length;for(a=0;a<256;a++)s[a]=a;for(a=0;a<256;a++)n=(n+s[a]+e.codePointAt(a%o))%256,[s[a],s[n]]=[s[n],s[a]];for(a=n=0,r=0;r<i;r++)a=(a+1)%256,n=(n+s[a])%256,[s[a],s[n]]=[s[n],s[a]],c.push(String.fromCodePoint(t.codePointAt(r)^s[(s[a]+s[n])%256]));return c.join("")}function Be(t,n=1e6){let a,r=1,s=10/n;for(let e=1;e<=n&&r>=s;e*=10)a=Math.round(t*e)/e,r=Math.abs((t-a)/t);return a}function Xe(e,t,n){void 0===t&&(t=1);const r={},a=Array.from(e.keys());e.forEach(e=>{delete(r[e.id]=e).id});e=!!n.previous;const s=n.previous||{};n.previous=JSON.parse(JSON.stringify(r)),a.forEach(e=>{const t=r[e],n=s[e];var a;n&&(Object.keys(t).forEach(e=>{t[e]===n[e]&&delete t[e]}),(0===(a=Object.keys(t).length)||1===a&&t.timestamp)&&delete r[e])});let c=-1/0;if(a.forEach(e=>{e=r[e];e&&e.timestamp>c&&(c=e.timestamp)}),c===-1/0&&(c=Date.now()),a.forEach(e=>{const t=r[e];t&&(t.timestamp&&t.timestamp!==c&&(t.t=Math.round(t.timestamp-c)),delete t.timestamp)}),r.t=Math.round(c),(void 0===t||2&t)&&e){const i=e=>(n.dict.has(e)||n.dict.set(e,n.dict.size),n.dict.get(e));n.dict||(n.dict=new Map);e=n.dict.size;if(a.forEach(e=>{const n=r[e];var t;n&&(t=i(e),r[t]=n,delete r[e],Object.keys(n).forEach(e=>{var t=i(e);if(n[t]=n[e],delete n[e],"object"==typeof n[t]&&void 0!==n[t].length)try{n[t]=n[t].map(e=>"string"==typeof e?i(e):e)}catch(e){g.log("exception",e)}else"number"==typeof n[t]&&(n[t]=Be(n[t]))}))}),e!=n.dict.size){const d=Array.from(n.dict.entries()).slice(e);r.dict=d.map(([e,t])=>e+"/"+t).join(",")}}let o=JSON.stringify(r).replace(/"(\w+)":/g,"$1:");if(void 0===t||1&t){const l="Se:"+String.fromCodePoint(o.length);e=(new TextEncoder).encode(l.substring(3,4)+Ue(l,o));o=l.substring(0,3)+btoa(String.fromCodePoint(...e))}else(void 0===t||2&t)&&(o="Sc:"+o);return o}function Ge(){const e=new Date;x.state={sid:e.toISOString().substring(0,10).replace(/[^\d]/g,"")+(""+Math.random()).substring(2,10),seq:0,url:window.location.href}}function Ke(){var e;x.state&&x.viewer&&(e=x.viewer.replace(/\{\{sid\}\}/g,x.state.sid),window.open(e,"_blank"))}function Ye(){let{ws:t,wsurl:e,retry:c,wstimer:o,sent:i,queue:d,unloading:l}=x;var n;window.addEventListener("beforeunload",e=>{if(l=x.unloading=!0,t){let{ws:e,wstimer:t}=x;t&&(clearTimeout(t),t=x.wstimer=null);if(e){const n=e;e.onerror=onclose=null,e=x.ws=null,n.close()}}}),e||(n=x.url.replace(/\{\{sid\}\}/g,x.state.sid),"ws:"!=(e=x.wsurl=new URL(n)).protocol&&"wss:"!=e.protocol||function s(){t=x.ws=new yt(e,"savestats");t.onopen=e=>{c=x.retry=2e3,d.forEach(e=>{e&&i.push(e),t.send(e)}),d.splice(0,d.length)};t.onerror=t.onclose=e=>{let t=x["ws"];if(t){if(t.bufferedAmount){let e=t.bufferedAmount;for(;0<e&&0<i.length;){const n=i.pop();e-=n.length;try{const a=JSON.parse(n);a.resent=!0,n=JSON.stringify(a)}catch(e){}d.unshift(n)}}if(t.onerror=t.onclose=null,t=x.ws=null,!l){const r=Math.max(1e3,c-8e3+Math.round(8e3*Math.random()));c=x.retry=Math.min(18e4,2*c),o=x.wstimer=setTimeout(()=>{o=x.wstimer=null,s()},r)}}}}())}function Ze(e,t){const{ws:n,url:a,sent:r,queue:s,warned:c,maxsize:o}=x;void 0===e.seq&&(e.seq=++x.state.seq),"result"===e.type&&"getStats"==e.name||void 0!==e.time||(e.time=Date.now()),"method"==e.type&&"construct"==e.name&&(e.state={url:window.location.href}),("event"==e.type||"method"==e.type&&(e.name.endsWith("OnSuccess")||e.name.endsWith("OnFailure"))||"result"==e.type&&"getStats"==e.name)&&e.data&&(e.data=e.data[0]);var i,e=JSON.stringify(e)+"\n";a?.startsWith("ws")?n&&n.readyState===WebSocket.OPEN?(!n.bufferedAmount&&0<r.length&&r.splice(0,r.length),r.push(e),n.send(e)):(s.push(e),s.length>o&&(c?c&&s.length<o&&(c=x.warned=!1):(c=x.warned=!0,g.warn("savestats queue size limit reached, will lose earlier data"),s.splice(0,s.length-o)))):a?.startsWith("http")?(i=a.replace(/\{\{sid\}\}/g,x.state.sid),_t(i,{method:"POST",body:e,headers:t||{"Content-Type":"application/json"}}).then(e=>{e.ok||g.log("failed to savestats")}).catch(e=>{g.error("failed to savestats",e)})):g.warn("invalid url to savestats")}function Qe(e){x.state||Ge(),!x.ws&&x.url?.startsWith("ws")&&Ye(),Ze(e)}window.RTCPeerConnection=e(window.RTCPeerConnection,"pc",{preconstruct:function(e,t){M(e,"method","preconstruct",t)},construct:function(s,e){M(s,"method","construct",e),s.addEventListener("connectionstatechange",e=>{M(s,"event",e.type,[{value:e.currentTarget.connectionState}])}),s.addEventListener("icecandidate",e=>{if(!e._intercepted){var t=[e.candidate];if(M(s,"event",e.type,t),1===t.length&&e.candidate===t[0]||(e.preventDefault(),e.stopImmediatePropagation()),1===t.length&&e.candidate!==t[0]){const n=new Event("icecandidate");Object.assign(n,{candidate:t[0]}),n._intercepted=!0,s.dispatchEvent(n)}}}),s.addEventListener("icecandidateerror",e=>{M(s,"event",e.type,[{errorCode:e.errorCode,url:e.url,errorText:e.errorText}])}),s.addEventListener("iceconnectionstatechange",e=>{M(s,"event",e.type,[{value:e.currentTarget.iceConnectionState}])}),s.addEventListener("icegatheringstatechange",e=>{M(s,"event",e.type,[{value:e.currentTarget.iceGatheringState}])}),s.addEventListener("negotiationneeded",e=>{M(s,"event",e.type)}),s.addEventListener("signalingstatechange",e=>{M(s,"event",e.type,[{value:e.currentTarget.signalingState}])}),s.addEventListener("track",n=>{if(!n._intercepted){let e=n.streams&&n.streams[0],t=n.track;var a=[{track:t,stream:e}];if(M(s,"event",n.type,a),1===a.length&&a[0].track===t&&a[0].stream===e||(n.preventDefault(),n.stopImmediatePropagation()),1==a.length){t=a[0].track,e=a[0].stream;const r=new Event("track");Object.assign(r,{track:t,streams:[e]}),r._intercepted=!0,s.dispatchEvent(r)}}}),s.addEventListener("datachannel",e=>{if(!e._intercepted){e.preventDefault(),e.stopImmediatePropagation();var t=[{channel:e.channel}];M(s,"event",e.type,t);const n=new Event("datachannel");n._intercepted=!0,n.channel=Je(t[0].channel,s),s.dispatchEvent(n)}});const a=j.get(s),r=()=>{x.enable&&s.getStats().then(e=>{const t=(j.get(s)||{}).state,n=t.interval;M(s,"result","getStats",[e]).then(()=>{t.interval!==n&&(g.log(`changed mediastats interval ${n||"default"}=>`+t.interval),clearInterval(a.timer2),a.timer2=setInterval(r,t.interval))})}).catch(e=>{g.warn(a.id+": failed to getStats()",e),a.timer1&&(clearTimeout(a.timer1),delete a.timer1),a.timer2&&(clearInterval(a.timer2),delete a.timer2)})};a.timer1=setTimeout(r,200),a.timer2=setInterval(r,x.interval)},createOffer:function(e,t){return O(e,"createOffer",t)},createAnswer:function(e,t){return O(e,"createAnswer",t)},setLocalDescription:function(e,t){return O(e,"setLocalDescription",t)},setRemoteDescription:function(e,t){return O(e,"setRemoteDescription",t)},addIceCandidate:function(e,t){return O(e,"addIceCandidate",t)},addTrack:function(e,t){return M(e,"method","addTrack",[t[0]]),e.addTrack(...t)},removeTrack:function(e,t){return M(e,"method","removeTrack",[t[0].track]),e.removeTrack(...t)},createDataChannel:function(e,t){return M(e,"method","createDataChannel",t),Je(e.createDataChannel(...t),e)},close:function(e,t){const n=j.get(e);return n&&(n.timer1&&(clearTimeout(n.timer1),delete n.timer1),n.timer2&&(clearInterval(n.timer2),delete n.timer2)),M(e,"method","close"),e.close(...t)}});const et={full:/^(select\s)?(.*)\sfrom\s([\w\-]+)(\swhere\s(.*))?$/,select:/^((max|min|sum)\s)?(\w+)(\s(if\s(present|valid)))?(\s(since\sprevious))?$/,where:/^(\w+)\s((present|valid)|(is\s(\w+)))$/};function tt(e){return Object.fromEntries(Object.entries(e).map(([n,e])=>{var t=e.match(et.full);if(!t)throw new Error("invalid config for "+n+": "+e);const a=t[3],r=t[2],s=t[5];e=r.split(" and ").map(e=>{var t=e.match(et.select);if(!t)throw new Error("invalid select in config for "+n+": "+e);e=t[2];return{attr:t[3],check:t[6]||void 0,delta:!!t[8],aggregate:e}}),t=s?s.split(" and ").map(e=>{var t=e.match(et.where);if(t)return{attr:t[1],check:t[3]||void 0,value:t[5]};throw new Error("invalid where in config for "+n+": "+e)}):[];return[n,{type:a,select:e,where:t}]}))}function nt(e,i,d){return i instanceof RTCStatsReport&&(i=Array.from(i.values())),d instanceof RTCStatsReport&&(d=Array.from(d.values())),Object.fromEntries(Object.entries(e).map(([e,t])=>{const{type:n,select:r,where:a}=t,s=i.filter(e=>e.type===n).filter(n=>a.every(e=>{var t=n[e.attr];return"present"===e.check?void 0!==t:"valid"===e.check?t:!e.value||t===e.value})).map(n=>{var e=r.find(e=>"interval"===e.attr||e.delta);const a=e?d?.find(e=>e.id===n.id):void 0;if(!e||a)return r.map(e=>{if("interval"===e.attr)return Math.round(n.timestamp-a.timestamp)/1e3;if("count"===e.attr)return 1;let t=n[e.attr];if(("present"===e.check&&void 0===t||"valid"===e.check&&!t)&&(t=void 0),e.delta&&void 0!==t){const a=d?.find(e=>e.id===n.id);t=Math.max(0,t-(a?.[e.attr]||0))}return t})}).filter(e=>void 0!==e);if(0<s.length){const c=new Array(r.length);for(let t=0;t<c.length;++t){const{aggregate:o,attr:e}=r[t];"sum"===o||"count"===e?c[t]=s.map(e=>e[t]).reduce((e,t)=>e+(t||0),0):c[t]="max"===o?s.map(e=>e[t]).reduce((e,t)=>Math.max(e,t||0),0):s[0][t]}return[e,1===c?.length?c[0]:c]}return[e,void 0]}).filter(([,e])=>void 0!==e))}function at(e,o){var t=e.split(" else ").map(e=>{const n=e.match(/^([\d\-\.]+)\sto\s([\d\-\.]+)\sif\s([\d\-\.\w]+)\sis\s([\d\-\.]+)\sto\s([\d\-\.]+)(%\sof\s([\d\-\.\w]+))?$/);if(n){var a,r=parseFloat(n[1]),s=parseFloat(n[2]),c=n[3].match(/^[\d\-\.]+$/)?parseFloat(n[3]):o?.[n[3]];let e=parseFloat(n[4]),t=parseFloat(n[5]);return n[6]&&(a=n[7].match(/^[\d\-\.]+$/)?parseFloat(n[7]):o?.[n[7]],e*=a/100,t*=a/100),{x0:e,x1:t,x:c,y0:r,y1:s}}g.log("failed to parse: "+e)}).filter(e=>void 0!==e);for(let e=0;e<t.length;++e){var{x0:n,x1:a,x:r,y0:s,y1:c}=t[e];if(0===e&&r<n)return s;if(e===t.length-1&&a<=r)return c;if(n<=r&&r<a)return(r-n)*(c-s)/(a-n)+s}g.log("failed in factor: "+e)}function rt(e,t,n,a,r){b("set_mediastats",[e,t,n,a,r])}const S={enable:!1,params:null,process:null,is_async:!1};function st(e){var{params:e,process:t,is_async:n}=w(e);t?(S.enable=!0,S.params=e,S.process=t,S.is_async=n):S.enable=!1}v&&b("mediacodec",[]).then(e=>{"object"==typeof e&&e.mediacodec?st(e.mediacodec):S.enable=!1});const T={enable:!1,params:null,process:null};function ct(e){var{params:e,process:t}=w(e);t?(T.enable=!0,T.params=e,T.process=t):T.enable=!1}v&&b("mediaconnect",[]).then(e=>{"object"==typeof e&&e.mediaconnect?ct(e.mediaconnect):T.enable=!1});const C={enable:!1,params:null,process:null};function ot(e){var{params:e,process:t}=w(e);t?(C.enable=!0,C.params=e,C.process=t):C.enable=!1}function it(e){var{params:e,process:t}=w(e);t?(x.enable=!0,x.params=e,x.process=t):x.enable=!1}v&&b("medianetwork",[]).then(e=>{"object"==typeof e&&e.medianetwork?ot(e.medianetwork):C.enable=!1}),v&&b("mediastats",[]).then(e=>{"object"==typeof e&&e.mediastats?it(e.mediastats):x.enable=!1});const D={enable:!1,params:null,process:null};function dt(e){var{params:e,process:t}=w(e);t?(D.enable=!0,D.params=e,D.process=t):D.enable=!1}function lt(t,n,e){return e.map(e=>{switch(e){case"id":return t.id;case"data":return t.state;case"config":case"configuration":return n[0];case"constraints":return n.length<2&&n.push({}),n[1];default:return L(e)}})}function ut(t,n,a,e){return e.map(e=>{switch(e){case"id":return(j.get(t)||{}).id;case"data":return(j.get(t)||{}).state;case"session":return a[0];case"context":return n;case"connection":return t;default:return L(e)}})}function pt(t,n,a,e){return e.map(e=>{switch(e){case"id":return(j.get(t)||{}).id;case"data":return(j.get(t)||{}).state;case"context":return n;case"candidate":return a[0];case"connection":return t;default:return L(e)}})}function ft(t,n,a,r,s,e){return e.map(e=>{switch(e){case"id":return(j.get(t)||{}).id;case"data":return(j.get(t)||{}).state;case"type":return n;case"context":return a;case"args":return r;case"channel":return s;case"connection":return t;default:return L(e)}})}function mt(t,n,a,r,e){const s=j.get(t)||{};return e.map(e=>{switch(e){case"id":return s.id;case"data":return s.state;case"type":return n;case"name":return a;case"args":return r;case"compress":return function(e,t){return Xe(e,t,s)};case"send":return Qe;case"parsequery":return tt;case"query":return nt;case"factor":return at;case"plot":return rt;case"connection":return t;case"videos":return[...h.values()].filter(e=>"VIDEO"==e.nodeName);default:return L(e)}})}async function M(t,n,a,r,s){if(T.enable&&"method"==n&&"preconstruct"==a&&({params:c,process:i}=T,i&&(r.length<1&&r.push({}),void 0!==(i=y(i,lt(t,r,c)))&&(r[0]=i))),S.enable&&"method"==n&&0<=["createOfferOnSuccess","createAnswerOnSuccess","setLocalDescription","setRemoteDescription"].indexOf(a)){const{params:e,process:l}=S;if(l){const u=ut(t,a,r,e);if(0<=e.indexOf("transform")){var c=e.indexOf("transform");try{var o=await import(p+"/../ext/sdp-transform.js");u[c]=o.default}catch(e){g.warn("failed to load sdp-transform",e),u[c]=void 0}}var i=await y(l,u,!0);void 0!==i&&(r[0]=i)}}if(C.enable&&("method"==n&&"addIceCandidate"==a||"event"==n&&"icecandidate"==a)&&({params:o,process:c}=C,c&&(i=pt(t,a,r,o),o=r[0]&&r[0].candidate,c=y(c,i),null!==o&&null===c?r.splice(0,r.length):void 0!==c&&o&&o!=c.candidate&&(r[0]=new RTCIceCandidate({candidate:c.candidate,sdpMid:r[0].sdpMid,sdpMLineIndex:r[0].sdpMLineIndex,usernameFragment:r[0].usernameFragment})))),"mediaconnect"==_.mode&&("method"==n&&("addTrack"==a||"removeTrack"==a)||"event"==n&&"track"==a)&&qe(a,r[0]),E.enable&&"event"==n&&"track"==a){var{params:i,process:o}=E;if(o){var{stream:c,track:d}=r[0],c=Ne({stream:c,context:"ontrack",track:d},i);E.calling+=1;let e;try{e=y(o,c)}finally{--E.calling}e&&(e.track||e.stream?r[0]=e:r.splice(0,1))}}if(D.enable&&("method"==n&&"createDataChannel"==a||"event"==n&&"datachannel"==a||"RTCDataChannel.method"==n||"RTCDataChannel.event"==n)&&({params:d,process:i}=D,i&&y(i,ft(t,n,a,r,s,d))),x.enable&&!("method"==n&&"preconstruct"==a||"method"!=n&&"event"!=n&&"result"!=n)){var{params:o,process:c}=x;if(c){let e=null;r&&r[0]&&("event"==n&&"track"==a||"method"==n&&("addTrack"==a||"removeTrack"==a))&&({kind:i,label:s,remote:d}=r[0],e={kind:i,label:s,remote:d});i=mt(t,n,a,e?[e]:r,o);await y(c,i,!0)}}}v&&b("datachannel",[]).then(e=>{"object"==typeof e&&e.datachannel?dt(e.datachannel):D.enable=!1});const R={enable:void 0,params:null,process:null,queue:[],events:[]};function ht(e){var{params:e,process:t}=w(e);t?(R.enable=!0,R.params=e,R.process=t):R.enable=!1}v&&b("websocket",[]).then(e=>{"object"==typeof e&&e.websocket?ht(e.websocket):R.enable=!1,R.queue.forEach(e=>{const t=e.attach;delete e.attach,t()}),R.queue.splice(0,R.queue.length)});const vt=new Set,gt=new Map;function bt(e,r,o){return new Proxy(e,{construct(n,a){if(!1===R.enable)return new n(...a);const c={sets:[]},t=async()=>{var e={id:r+ ++Fe,state:{}},t=("function"==typeof o.preconstruct&&await o.preconstruct(e,a),new n(...a));vt.add(t),gt.set(t,e),"function"==typeof o.construct&&await o.construct(t,a),c.obj=t};return void 0!==R.enable?t().then(()=>{const e=c["sets"];delete c.sets,(e||[]).forEach(({prop:e,value:t})=>{Reflect.set(c.obj,e,t)})}):(c.attach=()=>{const e=c["sets"];delete c.sets,t().then(()=>{(e||[]).forEach(({prop:e,value:t})=>{Reflect.set(c.obj,e,t)})})},R.queue.push(c)),new Proxy(c,{set(e,t,n){if(c.obj){const e=c.obj;return Reflect.set(e,t,n)}return c.sets.push({prop:t,value:n}),n},get(e,r){if(c.obj){const e=c.obj,s=c.obj;return"function"==typeof e[r]?new Proxy(e[r],{apply(e,t,n){if("function"!=typeof o[r])return Reflect.apply(e,s,n);if("close"!=r)return o[r](s,n);{const a=o[r](s,n);if(!("object"==typeof a&&a instanceof Promise))return setTimeout(()=>{vt.delete(s),gt.delete(s)}),a;a.then(()=>{setTimeout(()=>{vt.delete(s),gt.delete(s)})})}}}):Reflect.get(e,r)}g.warn("getter undefined for",r)}})}})}function wt(t,n,a,r,e){return e.map(e=>{switch(e){case"data":return("method"==n&&"preconstruct"==a?t:gt.get(t)||{}).state;case"type":return n;case"context":return a;case"args":return r;case"socket":return t;default:return L(e)}})}var yt=window.WebSocket;async function I(e,t,n,a){if("method"==t&&"preconstruct"==n){var{params:r,process:s}=R;if(s){const c=wt(e,t,n,a,r);r=await y(s,c);r&&(c[0]=r)}}else"method"!=t&&"event"!=t||({params:s,process:r}=R,r&&await y(r,wt(e,t,n,a,s),!0))}window.WebSocket=bt(window.WebSocket,"ws",{preconstruct:async function(e,t){await I(e,"method","preconstruct",t)},construct:async function(i,e){await I(i,"method","construct",e),["close","error","open","message"].forEach(o=>{i.addEventListener(o,async t=>{var e=R.events.indexOf(t);if(e<0){t.preventDefault(),t.stopImmediatePropagation();var n,a,r,s,c=[t];if(await I(i,"event",t.type,c),c.length){let e;"message"==o?({data:c,origin:n,lastEventId:a,source:r,ports:s}=t,e=new MessageEvent("message",{data:c,origin:n,lastEventId:a,source:r,ports:s})):(e=new Event(o),"error"==o&&t.error&&(e.error=t.error)),R.events.push(e),i.dispatchEvent(e)}}else R.events.splice(e,1)})})},send:async function(e,t){return await I(e,"method","send",t),e.send(...t)},close:async function(e,t){return await I(e,"method","close",t),e.close(...t)}});const P={enable:void 0,params:null,process:null,queue:[]};function kt(e){var{params:e,process:t}=w(e);t?(P.enable=!0,P.params=e,P.process=t):P.enable=!1}function A(t,n,a,r,e,s,c){return e.map(e=>{switch(e){case"data":return r;case"context":return t;case"args":return n;case"xhr":return a;case"resolve":return s;case"reject":return c;default:return L(e)}})}v&&b("webrequest",[]).then(e=>{"object"==typeof e&&e.webrequest?kt(e.webrequest):P.enable=!1;const t=P.queue.slice();0<t.length&&(P.queue.splice(0,P.queue.length),t.forEach(e=>{if("fetch"==e.type){var{args:t,resolve:n,reject:a}=e;fetch(...t).then(n).catch(a)}else if("open"==e.type||"send"==e.type){const{type:r,xhr:s,args:c}=e;s[r](...c)}}))});var _t=P.fetch=window.fetch;window.fetch=(...n)=>{if(!1!==P.enable)return new Promise((s,c)=>{if(void 0===P.enable)P.queue.push({type:"fetch",args:n,resolve:s,reject:c});else{const t=P.fetch,{params:o,process:i}=P;if(P.enable&&i){const d={};let r=!1;const l=e=>{r=!0,s(e)},u=e=>{r=!0,c(e)};var e=A("fetch",n,void 0,d,o,l,u);y(i,e,!0).then(()=>{r?g.log("fetch already responded, not calling"):0<n.length?t(...n).then(t=>{if(r)g.log("fetchresponse already responded",t);else{const n=t.clone(),a=[n];var e=A("fetchresponse",a,void 0,d,o,l,u);y(i,e,!0).then(e=>{r?g.log("fetchresponse already responded"):0<a.length?e?s(e):a[0]===n?s(t):s(a[0]):g.log("suppressing fetch response")}).catch(e=>{g.log("fetchresponse on error",e),c(e)})}}).catch(t=>{if(r)g.log("fetcherror already responded",t);else{const n=[t];var e=A("fetcherror",n,void 0,d,o,l,u);y(i,e,!0).then(e=>{r?g.log("fetcherror already responded"):0<n.length?e?s(e):n[0]===t?c(t):c(n[0]):g.log("suppressing fetch error")}).catch(e=>{g.log("fetcherror on error",e),c(e)})}}):g.log("suppressing fetch")}).catch(e=>{g.log("suppressing fetch on error",e),c(e)})}else t(...n).then(e=>s(e)).catch(e=>c(e))}});{const e=P.fetch;return e(...n)}},P.open=XMLHttpRequest.prototype.open,P.send=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.open=function(...t){if(void 0===P.enable)P.queue.push({type:"open",xhr:this,args:t});else{const{open:n,send:a,params:r,process:s}=P;if(P.enable&&s){let e=this._data;e=e||(this._data={state:{}}),y(s,A("open",t,this,e.state,r),!0).catch(e=>{g.log("open on error",e)}).finally(()=>{0<t.length?(e.opened=!0,n.apply(this,t),e.pending_send&&a.apply(this,e.pending_send)):g.log("suppressing open")})}else n.apply(this,t)}},XMLHttpRequest.prototype.send=function(...t){if(void 0===P.enable)P.queue.push({type:"send",xhr:this,args:t});else{const{send:s,params:c,process:o}=P;if(P.enable&&o){let n=this._data,e=(n=n||(this._data={state:{}}),!1);const i=()=>{e||(e=!0,["response","responseText","status","readyState"].forEach(e=>{let t=this[e];Object.defineProperty(this,e,{get:function(){return t},set:function(e){t=e},enumerable:!0,configurable:!0})}))},d=this.onreadystatechange;let a=!1;const l=e=>{a||(i(),a=!0,this.status=200,e&&(this.response=this.responseText=e),this.readyState=4,d&&d.apply(this,[]))},u=e=>{a||(i(),a=!0,this.status=0,e&&(this.response=this.responseText=e),this.readyState=4,d&&d.apply(this,[]))};this.onreadystatechange=function(...e){var t;4==this.readyState?(i(),t=A("readystatechange",e,this,n.state,c,l,u),y(o,t,!0).catch(e=>{g.log("response on error",e)}).finally(()=>{!a&&d&&d.apply(this,e)})):!a&&d&&d.apply(this,e)};var r=A("send",t=t.length?t:[null],this,n.state,c,l,u);y(o,r,!0).then(()=>{a?g.log("send already responded"):0<t.length?n.opened?s.apply(this,t):n.pending_send=t:g.log("suppressing send")}).catch(e=>{g.log("send on error",e),a?g.log("send error already responded"):(this.status=0,this.responseText=e,this.readyState=4,d&&d.apply(this,[]),this.onerror&&this.onerror(new ProgressEvent("error")))})}else s.apply(this,t)}};const q={enable:!1,params:null,process:null,subscribes:{}};function Et(e){var t,{params:e,process:n}=w(e);if(!n)return t=q.enable,q.enable=!1,void(t&&b("on_cpuperformance",[{value:!1}]));q.enable=!0,q.params=e,q.process=n,b("on_cpuperformance",[{value:!0}])}function jt(e,t){N&&(t&&"function"==typeof t?(q.subscribes[e]||(q.subscribes[e]=[]),q.subscribes[e].indexOf(t)<0&&(q.subscribes[e].push(t),1===q.subscribes[e].length&&b("on_cpuperformance",[{condition:e,value:!0}]))):void 0===t&&Ot(e))}function Ot(t,n){if(N){var a=q.subscribes[t];let e=!1;void 0===n?a&&(e=!0,delete q.subscribes[t]):0<=(a=(q.subscribes[t]||[]).indexOf(n))&&(q.subscribes[t].splice(a,1),q.subscribes[t].length||(e=!0,delete q.subscribes[t])),e&&b("on_cpuperformance",[{condition:t,value:!1}])}}function xt(n,e){let t=!1;const{condition:a,value:r}=n;var s,c;if(q.enable&&({process:s,params:c}=q,s&&y(s,St(r,c),"single").catch(e=>{}),t=!0),a){const o=q.subscribes[a];o&&(t=!0,o.forEach(e=>{try{const t=e(n.value);"object"==typeof t&&t instanceof Promise&&t.catch(e=>{g.warn("promise error in on "+a+" handler",e)})}catch(e){g.warn("exception in on "+a+" handler",e)}}))}t||e||b("on_cpuperformance",[{condition:a,value:!1}])}function St(t,e){return e.map(e=>"details"!==e?L(e):t)}function Tt(e){let t;switch(e){case"videocapture":t=a;break;case"screencapture":t=i;break;case"devicelist":t=n;break;case"mediadisplay":t=f;break;case"mediastream":t=E;break;case"mediarecord":t=_;break;case"usermedia":t=d;break;case"mediacodec":t=S;break;case"mediaconnect":t=T;break;case"medianetwork":t=C;break;case"mediastats":t=x;break;case"datachannel":t=D;break;case"websocket":t=R;break;case"cpuperformance":t=q}if(t)return"mediarecord"==e||t.enable?t.process:null}function L(e){switch(e){case"global":return te;case"respath":return p;case"console":return g;case"controls":return F;case"cputime":return V;case"location":{const t="hash, host, hostname, href, origin, pathname, port, protocol, search".split(", ");return Object.keys(window.location).filter(e=>0<=t.indexOf(e)).reduce((e,t)=>(e[t]=window.location[t],e),{})}default:return}}v&&b("cpuperformance",[]).then(e=>{"object"==typeof e&&e.cpuperformance?Et(e.cpuperformance):q.enable=!1}),v||(window._rtchelper_setprocess=W)};if(document.querySelector("html").hasAttribute("rtchelper-respath")){const t=document.querySelector("html").getAttribute("rtchelper-respath"),n=document.querySelector("html").getAttribute("rtchelper-nonce"),a=(document.querySelector("html").removeAttribute("rtchelper-nonce"),document.querySelector("html").removeAttribute("rtchelper-respath"),document.querySelector("html").setAttribute("rtchelper",""),window.BroadcastChannel?new BroadcastChannel(n):window);e(a,n,t,!0)}window._rtchelper_content=e})();
