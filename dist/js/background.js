const version=chrome.runtime.getManifest().manifest_version,random=(2<version&&chrome.scripting.registerContentScripts([{id:"inject",allFrames:!0,js:["js/inject.js"],matches:["https://*/*","http://localhost:*/*"],world:"MAIN",runAt:"document_start"}]).catch(e=>console.log("failed to inject",e)),e=>(""+Math.random()).substring(2,e||8)),active_domains={},active_subscribes={},active_monitor={};let mode="";const tabs=["videocapture","screencapture","devicelist","mediarecord","mediadisplay","mediastream","usermedia","mediacodec","mediaconnect","medianetwork","mediastats","datachannel","websocket","webrequest","cpuperformance","usercontrols"],pagesecurity={},pending_domains={};let options_tab=null,options_win=null;const active_tabs=[];function set_icon(e){2<version?(e.path=chrome.runtime.getURL(e.path),chrome.action.setIcon(e)):chrome.browserAction.setIcon(e)}function tab_to_string(e){return{videocapture:"Video Capture",screencapture:"Screen Capture",devicelist:"Device List"}[e]}function create_default_value(){return{videocapture:`function(canvas, video) {
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
}`}}function get_usercontrols_variables(e){return Object.fromEntries((e.usercontrols?.variables||[]).map(e=>[e.varname,e.value]))}function on_usercontrols_change(e,t,i,s,o){const a=[],n=active_subscribes[e]?Object.entries(active_subscribes[e]):[];let r=null;if(t&&o){const c=n.find(e=>e[0]===t);c?c[1]=[o].push(...c[1]):n.splice(0,0,[t,[o]]),r={tabId:t,varname:o}}return n.forEach(([n,e])=>{e.forEach(e=>{if(i[e]!==s[e]){var t={varname:e,value:s[e],old:i[e]};a.push(t);const o={dir:"from",method:"onusercontrols",data:t};r&&r.tabId==n&&r.varname==e&&(o.sender=!0),chrome.tabs.sendMessage(parseInt(n),o,void 0,e=>{e||console.log("failed to send onusercontrols tabId="+n,chrome.runtime.lastError)})}})}),a}chrome.storage.local.get(e=>{e.settings&&e.settings.mode&&(mode=e.settings.mode)}),chrome.storage.onChanged.addListener((e,t)=>{if("local"==t)for(var o in e){var n;"settings"==o&&(o=e[o],n=mode,(o=(o.newValue||{}).mode||"")!=n&&(mode=o))}}),(chrome.action||chrome.browserAction).onClicked.addListener(function(i){function t(t,e){if(mode&&mode.startsWith("inline")&&e){e=active_tabs.indexOf(i.id);e<0?active_tabs.push(i.id):active_tabs.splice(e,1);const o={dir:"content",method:"toggle",data:{domain:t,float:mode.startsWith("inline-float")}};mode.startsWith("inline")&&mode.indexOf(":")&&(o.data.side=mode.split(":")[1]),chrome.tabs.sendMessage(i.id,o)}else{const n=()=>{chrome.tabs.create({url:"options/index.html",pinned:"open-pinned"==mode},o=>{options_tab=o,"open-popup"==mode&&chrome.system.display.getInfo(e=>{var t={};e&&(e=e.find(e=>e.isPrimary)||e[0])&&e.workArea&&Object.assign(t,{left:Math.max(0,e.workArea.width-720),width:Math.min(720,e.workArea.width),top:e.workArea.top,height:Math.min(800,e.workArea.height)}),chrome.windows.create(Object.assign({tabId:o.id,type:"popup"},t),e=>{options_win=e})}),setTimeout(function(){chrome.runtime.sendMessage({options:{type:"select",domain:t}})},1e3)})};options_tab?chrome.tabs.get(options_tab.id,e=>{e.url=="chrome-extension://"+chrome.runtime.id+"/options/index.html"?chrome.tabs.update(options_tab.id,{active:!0},()=>{"open-popup"==mode&&options_win&&chrome.windows.update(options_win.id,{focused:!0},()=>{}),chrome.runtime.sendMessage({options:{type:"select",domain:t}})}):n()}):n()}}let o;for(var e in active_domains)if(0<=active_domains[e].indexOf(i.id)){o=e;break}if(o)t(o,!0);else{try{o=new URL(i.url).host}catch(e){}chrome.storage.local.get(["domain:"+o],function(e){e=e["domain:"+o];t(o,e)})}}),chrome.windows.onRemoved.addListener(function(e){}),chrome.tabs.onCreated.addListener(e=>{}),chrome.tabs.onRemoved.addListener(function(e,t){options_tab&&options_tab.id==e&&(options_tab=options_win=null);var o,n=active_tabs.indexOf(e);for(o in 0<=n&&active_tabs.splice(n,1),active_domains){var i=active_domains[o].indexOf(e);0<=i&&(active_domains[o].splice(i,1),0==active_domains[o].length&&delete active_domains[o],active_subscribes[o]&&active_subscribes[o][e]&&(delete active_subscribes[o][e],Object.keys(active_subscribes[o]).length||delete active_subscribes[o]),active_monitor[o]&&active_monitor[o][e]&&(delete active_monitor[o][e],Object.keys(active_monitor[o]).length||(delete active_monitor[o],Object.keys(active_monitor).length||stop_active_monitor())))}}),chrome.storage.onChanged.addListener((e,t)=>{if("local"==t)for(var o in e)if(o.startsWith("domain:")){var n=e[o];const i=o.substring("domain:".length);if(void 0!==n.newValue&&void 0!==n.oldValue){const s=n.newValue,a=n.oldValue;s&&!0!==s&&active_domains[i]&&active_domains[i].forEach(t=>{tabs.forEach(e=>{s[e]!=a[e]&&(e={dir:"from",method:"setprocess",domain:i,type:e,body:s[e]||""},chrome.tabs.sendMessage(t,e))})}),s&&!0!==s&&(s.pagesecurity?pagesecurity[i]=s.pagesecurity:pagesecurity[i]&&delete pagesecurity[i]);o=get_usercontrols_variables(n.oldValue),n=get_usercontrols_variables(n.newValue);on_usercontrols_change(i,void 0,o,n)}}}),chrome.storage.local.get(t=>{Object.keys(t).filter(e=>e.startsWith("domain:")).map(e=>[e.substring("domain:".length),t[e]]).forEach(e=>{var[e,t]=e;"object"==typeof t&&t.pagesecurity&&(pagesecurity[e]=t.pagesecurity)})}),chrome.runtime.onMessage.addListener(function(i,t,s){if(i.request){if(console.log("background: <<<",JSON.stringify(i)),i.request&&i.request.function){if(0<=tabs.indexOf(i.request.function)&&t.tab){const d=t.tab.url.match(/^http(s)?:\/\/([^\/]+)/)[2],l=t.tab.url.match(/^(http(s)?:\/\/([^\/]+))/)[1]+"/favicon.ico",m="domain:"+d,u=t.tab.id;return chrome.storage.local.get([m],e=>{if(e[m]){const o=e[m];if(!0!==o)for(var t in set_icon({path:"res/icon48.png",tabId:u}),void 0===active_domains[d]&&(active_domains[d]=[]),active_domains[d].indexOf(u)<0&&active_domains[d].push(u),o)t!=i.request.function&&delete o[t];e={id:i.id,dir:"from",nonce:i.nonce,response:{resolve:o}};console.log("background: >>>",JSON.stringify(e)),s(e)}else{async function n(t,e){try{const o=await fetch(e),i=(n=await o.blob(),await new Promise((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result),o.readAsDataURL(n)})),data={};i&&i.startsWith("data:image/")?data["favicon:"+t]=i:data["favicon:"+t]="",chrome.storage.local.set(data,()=>{})}catch(e){data["favicon:"+t]="",chrome.storage.local.set(data,()=>{})}var n}tab_to_string(i.request.function)?pending_domains[d]?pending_domains[d].push({message:i,sendResponse:s}):(pending_domains[d]=[{message:i,sendResponse:s}],create_notification({title:tab_to_string(i.request.function),contextMessage:d,message:"Click here to customize"}).then(()=>{const o=create_default_value(),e={};if(!0!==(e[m]=o))for(var t in set_icon({path:"res/icon48.png",tabId:u}),void 0===active_domains[d]&&(active_domains[d]=[]),active_domains[d].indexOf(u)<0&&active_domains[d].push(u),o)t!=i.request.function&&delete o[t];chrome.storage.local.set(e,()=>{n(d,l).catch(e=>{}).finally(()=>{const e=pending_domains[d];delete pending_domains[d],e.forEach(({message:e,sendResponse:t})=>{e={id:e.id,dir:"from",nonce:e.nonce,response:{resolve:o}};console.log("background: >>>",JSON.stringify(e)),t(e)})})})}).catch(e=>{const t={};t[m]=!0,chrome.storage.local.set(t,()=>{n(d,l).catch(e=>{}).finally(()=>{const e=pending_domains[d];delete pending_domains[d],e.forEach(({message:e,sendResponse:t})=>{e={id:e.id,dir:"from",nonce:e.nonce,response:{resolve:!0}};console.log("background: >>>",JSON.stringify(e)),t(e)})})})})):(e={id:i.id,dir:"from",nonce:i.nonce,response:{resolve:{}}},console.log("background: >>>",JSON.stringify(e)),s(e))}}),!0}{let e=null;if("set_usercontrols"==i.request.function){const f=t.tab.url.match(/^http(s)?:\/\/([^\/]+)/)[2],p="domain:"+f,v=t.tab.id,h=i.request.args[0];chrome.storage.local.get([p],e=>{if(e[p]){const t=e[p];if("object"==typeof t&&t.usercontrols&&t.usercontrols.variables){const o=t.usercontrols.variables.find(e=>e.varname==h.varname);if(o){const n=get_usercontrols_variables(t),i=(o.value=h.value,get_usercontrols_variables(t)),s={};s[p]=t,chrome.storage.local.set(s,()=>{const e=on_usercontrols_change(f,v,n,i,o.varname);e.forEach(e=>{chrome.runtime.sendMessage({options:{type:"setUserControls",data:e,domain:f}},e=>{e||console.log("ignore error in sending setUserControls, response=",e,chrome.runtime.lastError)})})})}else console.warn("undefined variable",h.varname)}}}),e={}}else if("on_usercontrols"==i.request.function||"on_cpuperformance"==i.request.function){var o=t.tab.url.match(/^http(s)?:\/\/([^\/]+)/)[2],n=t.tab.id,a=i.request.args[0];a.value?"on_usercontrols"==i.request.function?(active_subscribes[o]||(active_subscribes[o]={}),active_subscribes[o][n]||(active_subscribes[o][n]=[]),active_subscribes[o][n].indexOf(a.varname)<0&&active_subscribes[o][n].push(a.varname)):"on_cpuperformance"==i.request.function&&(r=!!Object.keys(active_monitor).length,active_monitor[o]||(active_monitor[o]={}),active_monitor[o][n]||(active_monitor[o][n]=[]),active_monitor[o][n].indexOf(a.condition)<0&&active_monitor[o][n].push(a.condition),r||start_active_monitor()):"on_usercontrols"==i.request.function?active_subscribes[o]&&active_subscribes[o][n]&&0<=(r=active_subscribes[o][n].indexOf(a.varname))&&(active_subscribes[o][n].splice(r,1),active_subscribes[o][n].length||(delete active_subscribes[o][n],Object.keys(active_subscribes[o]).length||delete active_subscribes[o])):"on_cpuperformance"==i.request.function&&active_monitor[o]&&active_monitor[o][n]&&0<=(r=active_monitor[o][n].indexOf(a.condition))&&(active_monitor[o][n].splice(r,1),active_monitor[o][n].length||(delete active_monitor[o][n],Object.keys(active_monitor[o]).length||(delete active_monitor[o],Object.keys(active_monitor).length||stop_active_monitor()))),e={}}else if("set_mediastats"==i.request.function){a=t.tab.url.match(/^http(s)?:\/\/([^\/]+)/)[2];const data=i.request.args;chrome.runtime.sendMessage({options:{type:"setMediastats",data:data,domain:a}},e=>{}),e={}}if(e){const c={id:i.id,dir:"from",nonce:i.nonce,response:e};return s(c),!0}}}else if(i.request&&i.request.triggerUserControls){var{triggerUserControls:r,domain:n}=i.request,o=(on_usercontrols_change(n,void 0,{},r),{});{const c={id:i.id,dir:"from",nonce:i.nonce,response:o};return s(c),!0}}const c={id:i.id,dir:"from",nonce:i.nonce,response:{reject:"Programming error"}};console.log("background: >>>",JSON.stringify(c)),s(c)}});let notifications={};function create_notification(e){let o={};var t=2<version?chrome.runtime.getURL("res/icon48.png"):"res/icon48.png",t=Object.assign({type:"basic",iconUrl:t,requireInteraction:!0,silent:!0,isClickable:!0},e);return chrome.notifications.create(t,e=>{notifications[e]={click_callback:o.resolve,close_callback:o.reject}}),new Promise((e,t)=>{o.resolve=e,o.reject=t})}chrome.notifications.onButtonClicked.addListener(function(e,t){notifications[e]&&(chrome.notifications.clear(e,()=>{}),notifications[e].click_callback(t),delete notifications[e])}),chrome.notifications.onClicked.addListener(function(e,t){notifications[e]&&(chrome.notifications.clear(e,()=>{}),notifications[e].click_callback(0),delete notifications[e])}),chrome.notifications.onClosed.addListener(function(e){notifications[e]&&(notifications[e].close_callback(),delete notifications[e])}),chrome.webNavigation.onCommitted.addListener(t=>{if(mode&&mode.startsWith("inline")&&"reload"==t.transitionType){const s=t.tabId;if(0<=active_tabs.indexOf(s)){let e,o;for(var n in active_domains)if(0<=active_domains[n].indexOf(t.tabId)){e=n;break}try{o=new URL(t.url).host}catch(e){}var i;e&&e==o?chrome.webNavigation.onCompleted.addListener(function e(){const t={dir:"content",method:"toggle",data:{domain:o,float:mode.startsWith("inline-float"),restore:!0}};mode.startsWith("inline")&&mode.indexOf(":")&&(t.data.side=mode.split(":")[1]),chrome.tabs.sendMessage(s,t),chrome.webNavigation.onCompleted.removeListener(e)}):(i=active_tabs.indexOf(s),active_tabs.splice(i,1))}}});const cpuperformance={interval:1e3,last:null,processors:0};function start_active_monitor(){var e;cpuperformance.timer||(e=()=>{chrome.system.cpu.getInfo(e=>{const t=e.processors.map(e=>e.usage);cpuperformance.processors||(cpuperformance.processors=t.length);let o=null;var n;cpuperformance.last&&(o=(e=t,n=cpuperformance.last,e.map((e,t)=>[e,n[t]]).map(([t,o])=>Object.fromEntries(Object.keys(t).map(e=>[e,t[e]-o[e]]))))),cpuperformance.last=t,send_cpuperformance(o||t.map(e=>null))})},setTimeout(e,0),cpuperformance.timer=setInterval(e,cpuperformance.interval))}function stop_active_monitor(){cpuperformance.timer&&(clearInterval(cpuperformance.timer),delete cpuperformance.timer,cpuperformance.last=null)}function send_cpuperformance(o){Object.entries(active_monitor).forEach(([,e])=>{Object.entries(e).forEach(([t,e])=>{e.forEach(e=>{match_cpuperformance_condition(e,o)&&(e={dir:"from",method:"oncpuperformance",data:{condition:e,value:o}},chrome.tabs.sendMessage(parseInt(t),e,void 0,e=>{e||console.log("failed to send oncpuperformance tabId="+t,chrome.runtime.lastError)}))})})})}function match_cpuperformance_condition(t,o){if(!t)return!0;t=t.match(/^\s*(avg|max)\s*(user|kernel|idle)?\s*(>|<|>=|<=)\s*(\d+)%?\s*$/);if(t&&0<o.length&&null!==o[0]){var n=parseInt(t[4])/100;let e;const s=t[2];var i=t[3];const a=o.map(e=>"user"==s?e.user/e.total:"kernel"==s?e.kernel/e.total:"idle"==s?e.idle/e.total:1-e.idle/e.total);if("avg"==t[1]?e=a.reduce((e,t)=>e+t,0)/a.length:"max"==t[1]&&(e=Math.max(...a)),">"==i)return e>n;if("<"==i)return e<n;if(">="==i)return e>=n;if("<="==i)return e<=n;if("=="==i)return Math.round(100*e)==Math.round(100*n)}return!1}function request_processor(o){var n=new URL(o.url).host;if(pagesecurity[n]){const e=pagesecurity[n];var n=e.match(/^(async\s+)?function\s*(\w+\s*)?\(([^\)]*)\)\s*\{([\s\S]*)\}\s*$/);if(n){let e=n[3],t=n[4];e=e.split(",").map(e=>e.trim()).filter(e=>!!e);const i=new Function(e,t);if(i)return n=e.map(e=>{if("details"===e)return o}),i.apply(null,n)}}}2<version||chrome.webRequest.onHeadersReceived.addListener(request_processor,{urls:["*://*/*"],types:["main_frame"]},["blocking","responseHeaders"]);
