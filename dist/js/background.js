const version=chrome.runtime.getManifest().manifest_version,random=(2<version&&chrome.scripting.registerContentScripts([{id:"inject",allFrames:!0,js:["js/inject.js"],matches:["https://*/*","http://localhost:*/*"],world:"MAIN",runAt:"document_start"}]).catch(e=>console.log("failed to inject",e)),e=>(""+Math.random()).substring(2,e||8)),active_domains={};let mode="";const tabs=["videocapture","screencapture","devicelist","mediastream","usermedia","mediacodec","mediaconnect","medianetwork","datachannel","websocket","webrequest"],pending_domains={};let options_tab=null,options_win=null;const active_tabs=[];function set_icon(e){2<version?(e.path=chrome.runtime.getURL(e.path),chrome.action.setIcon(e)):chrome.browserAction.setIcon(e)}function tab_to_string(e){return{videocapture:"Video Capture",screencapture:"Screen Capture",devicelist:"Device List"}[e]}function create_default_value(){return{videocapture:`function(canvas, video) {
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
}`}}chrome.storage.local.get(e=>{e.settings&&e.settings.mode&&(mode=e.settings.mode)}),chrome.storage.onChanged.addListener((e,t)=>{if("local"==t)for(var o in e){var i;"settings"==o&&(o=e[o],i=mode,(o=(o.newValue||{}).mode||"")!=i&&(mode=o))}}),(chrome.action||chrome.browserAction).onClicked.addListener(function(n){function t(t,e){if(mode&&mode.startsWith("inline")&&e){e=active_tabs.indexOf(n.id);e<0?active_tabs.push(n.id):active_tabs.splice(e,1);const o={dir:"content",method:"toggle",data:{domain:t,float:mode.startsWith("inline-float")}};mode.startsWith("inline")&&mode.indexOf(":")&&(o.data.side=mode.split(":")[1]),chrome.tabs.sendMessage(n.id,o)}else{const i=()=>{chrome.tabs.create({url:"options/index.html",pinned:"open-pinned"==mode},o=>{options_tab=o,"open-popup"==mode&&chrome.system.display.getInfo(e=>{var t={};e&&(e=e.find(e=>e.isPrimary)||e[0])&&e.workArea&&Object.assign(t,{left:Math.max(0,e.workArea.width-720),width:Math.min(720,e.workArea.width),top:e.workArea.top,height:Math.min(800,e.workArea.height)}),chrome.windows.create(Object.assign({tabId:o.id,type:"popup"},t),e=>{options_win=e})}),setTimeout(function(){chrome.runtime.sendMessage({options:{type:"select",domain:t}})},1e3)})};options_tab?chrome.tabs.get(options_tab.id,e=>{e.url=="chrome-extension://"+chrome.runtime.id+"/options/index.html"?chrome.tabs.update(options_tab.id,{active:!0},()=>{"open-popup"==mode&&options_win&&chrome.windows.update(options_win.id,{focused:!0},()=>{}),chrome.runtime.sendMessage({options:{type:"select",domain:t}})}):i()}):i()}}let o;for(var e in active_domains)if(0<=active_domains[e].indexOf(n.id)){o=e;break}if(o)t(o,!0);else{try{o=new URL(n.url).host}catch(e){}chrome.storage.local.get(["domain:"+o],function(e){e=e["domain:"+o];t(o,e)})}}),chrome.windows.onRemoved.addListener(function(e){}),chrome.tabs.onCreated.addListener(e=>{}),chrome.tabs.onRemoved.addListener(function(e,t){options_tab&&options_tab.id==e&&(options_tab=options_win=null);var o,i=active_tabs.indexOf(e);for(o in 0<=i&&active_tabs.splice(i,1),active_domains){var n=active_domains[o].indexOf(e);0<=n&&(active_domains[o].splice(n,1),0==active_domains[o].length&&delete active_domains[o])}}),chrome.storage.onChanged.addListener((e,t)=>{if("local"==t)for(var o in e)if(o.startsWith("domain:")){var i=e[o];const n=o.substring("domain:".length);if(void 0!==i.newValue&&void 0!==i.oldValue){const a=i.newValue,s=i.oldValue;a&&!0!==a&&active_domains[n]&&active_domains[n].forEach(t=>{tabs.forEach(e=>{a[e]!=s[e]&&(e={dir:"from",method:"setprocess",domain:n,type:e,body:a[e]||""},chrome.tabs.sendMessage(t,e))})})}}}),chrome.runtime.onMessage.addListener(function(n,e,a){if(n.request){if(console.log("background: <<<",JSON.stringify(n)),n.request&&n.request.function&&0<=tabs.indexOf(n.request.function)&&e.tab){const s=e.tab.url.match(/^http(s)?:\/\/([^\/]+)/)[2],c=e.tab.url.match(/^(http(s)?:\/\/([^\/]+))/)[1]+"/favicon.ico",r="domain:"+s,d=e.tab.id;return chrome.storage.local.get([r],e=>{if(e[r]){const o=e[r];if(!0!==o)for(var t in set_icon({path:"res/icon48.png",tabId:d}),void 0===active_domains[s]&&(active_domains[s]=[]),active_domains[s].indexOf(d)<0&&active_domains[s].push(d),o)t!=n.request.function&&delete o[t];e={id:n.id,dir:"from",nonce:n.nonce,response:{resolve:o}};console.log("background: >>>",JSON.stringify(e)),a(e)}else{async function i(t,e){try{const o=await fetch(e),n=(i=await o.blob(),await new Promise((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result),o.readAsDataURL(i)})),data={};n&&n.startsWith("data:image/")?data["favicon:"+t]=n:data["favicon:"+t]="",chrome.storage.local.set(data,()=>{})}catch(e){data["favicon:"+t]="",chrome.storage.local.set(data,()=>{})}var i}tab_to_string(n.request.function)?pending_domains[s]?pending_domains[s].push({message:n,sendResponse:a}):(pending_domains[s]=[{message:n,sendResponse:a}],create_notification({title:tab_to_string(n.request.function),contextMessage:s,message:"Click here to customize"}).then(()=>{const o=create_default_value(),e={};if(!0!==(e[r]=o))for(var t in set_icon({path:"res/icon48.png",tabId:d}),void 0===active_domains[s]&&(active_domains[s]=[]),active_domains[s].indexOf(d)<0&&active_domains[s].push(d),o)t!=n.request.function&&delete o[t];chrome.storage.local.set(e,()=>{i(s,c).catch(e=>{}).finally(()=>{const e=pending_domains[s];delete pending_domains[s],e.forEach(({message:e,sendResponse:t})=>{e={id:e.id,dir:"from",nonce:e.nonce,response:{resolve:o}};console.log("background: >>>",JSON.stringify(e)),t(e)})})})}).catch(e=>{const t={};t[r]=!0,chrome.storage.local.set(t,()=>{i(s,c).catch(e=>{}).finally(()=>{const e=pending_domains[s];delete pending_domains[s],e.forEach(({message:e,sendResponse:t})=>{e={id:e.id,dir:"from",nonce:e.nonce,response:{resolve:!0}};console.log("background: >>>",JSON.stringify(e)),t(e)})})})})):(e={id:n.id,dir:"from",nonce:n.nonce,response:{resolve:{}}},console.log("background: >>>",JSON.stringify(e)),a(e))}}),!0}e={id:n.id,dir:"from",nonce:n.nonce,response:{reject:"Programming error"}};console.log("background: >>>",JSON.stringify(e)),a(e)}});let notifications={};function create_notification(e){let o={};var t=2<version?chrome.runtime.getURL("res/icon48.png"):"res/icon48.png",t=Object.assign({type:"basic",iconUrl:t,requireInteraction:!0,silent:!0,isClickable:!0},e);return chrome.notifications.create(t,e=>{notifications[e]={click_callback:o.resolve,close_callback:o.reject}}),new Promise((e,t)=>{o.resolve=e,o.reject=t})}chrome.notifications.onButtonClicked.addListener(function(e,t){notifications[e]&&(chrome.notifications.clear(e,()=>{}),notifications[e].click_callback(t),delete notifications[e])}),chrome.notifications.onClicked.addListener(function(e,t){notifications[e]&&(chrome.notifications.clear(e,()=>{}),notifications[e].click_callback(0),delete notifications[e])}),chrome.notifications.onClosed.addListener(function(e){notifications[e]&&(notifications[e].close_callback(),delete notifications[e])}),chrome.webNavigation.onCommitted.addListener(t=>{if(mode&&mode.startsWith("inline")&&"reload"==t.transitionType){const a=t.tabId;if(0<=active_tabs.indexOf(a)){let e,o;for(var i in active_domains)if(0<=active_domains[i].indexOf(t.tabId)){e=i;break}try{o=new URL(t.url).host}catch(e){}var n;e&&e==o?chrome.webNavigation.onCompleted.addListener(function e(){const t={dir:"content",method:"toggle",data:{domain:o,float:mode.startsWith("inline-float"),restore:!0}};mode.startsWith("inline")&&mode.indexOf(":")&&(t.data.side=mode.split(":")[1]),chrome.tabs.sendMessage(a,t),chrome.webNavigation.onCompleted.removeListener(e)}):(n=active_tabs.indexOf(a),active_tabs.splice(n,1))}}});
