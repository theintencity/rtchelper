(window._rtchelper||document.querySelector("html").hasAttribute("rtchelper")?function(){}:function(){function e(h,i,s,e){const t=e=>(""+Math.random()).substring(2,e||8),r={},v={log:window.console.log,debug:window.console.debug,info:window.console.info,warn:window.console.warn,error:window.console.error},c=(h&&h.addEventListener("message",e=>{if(!(e.source&&e.source!==window||e.data.nonce!=i||"from"!=e.data.dir))if(e.data.method){if("setprocess"==e.data.method){var t=e.data.type,a=e.data.body;if(0<=c.indexOf(t))switch(t){case"videocapture":return void function(t){p.states.forEach(e=>{k("videocapture",e,t)})}(a);case"screencapture":return void function(t){f.states.forEach(e=>{k("screencapture",e,t)})}(a);case"mediastream":g(a)}}}else if(e.data.id){const n=r[e.data.id];n?(delete r[e.data.id],(t=e.data.response).reject?n.reject(t.reject):n.resolve(t.resolve)):v.warn("promise is already fullfilled: "+e.data.id)}}),["videocapture","screencapture","mediastream"]);function b(n,e){if(h){const a=t(),c={function:n,args:e};return h.postMessage({nonce:i,dir:"to",id:a,request:c}),new Promise((e,t)=>{r[a]={request:c,resolve:e,reject:t}})}return new Promise((e,t)=>{const a=function(e){let t;switch(e){case"videocapture":t=p;break;case"screencapture":t=f;break;case"mediastream":t=O}if(t)return t.enable?t.process:null}(n);obj={},a&&(obj[n]=a.toString()),e(obj)})}let o=window.trustedTypes?.createPolicy?trustedTypes.createPolicy("test",{createScriptURL:e=>e,createScript:(e,...t)=>{return`(${e?"async ":""}function anonymous(${t.slice(0,-1).join(",")}) { ${t.pop().toString()} })`}}):null;function d(c,i,r="local"){return new Promise((e,t)=>{if(c.pending_segment)t("already pending segment");else{if(c.pending_segment={resolve:e,reject:t},!c.segment_loaded){c.segment_loaded=!0;const a=()=>{const e=c.segmentation=new SelfieSegmentation({locateFile:e=>{const t="local"==r?s+"/../ext/selfie_segmentation-0.1.1675465747/"+e:"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1.1675465747/"+e;return t.endsWith(".js")?o.createScriptURL(t):t}});var t;e.setOptions({modelSelection:1}),e.onResults(e=>{if(c.pending_segment){const t=c.pending_segment["resolve"];delete c.pending_segment,t([e.segmentationMask,e.image])}}),c.pending_segment&&c.pending_segment.waiting&&(t=c.pending_segment.waiting,delete c.pending_segment.waiting,c.segmentation.send({image:t}).catch(e=>v.error(e)))};if(document.querySelector("script#virtualbackground"))c.segmentation&&c.segmentation.close(),a();else{const n=document.createElement("script");n.id="virtualbackground",n.setAttribute("crossorigin","anonymous");e="local"==r?s+"/../ext/selfie_segmentation-0.1.1675465747/selfie_segmentation.js":"https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation@0.1.1675465747/selfie_segmentation.js";n.setAttribute("integrity","sha384-J/3LshwuX+2viPOY3En4QiZvdvlffDhZYH5MsMuLGdwcoGcYSA7EV1jXFsys0gIb"),n.setAttribute("src",o.createScriptURL(e)),n.onload=()=>{a()},document.head.appendChild(n)}}t=i.videoWidth||i.naturalWidth||i.width,e=i.videoHeight||i.naturalHeight||i.height;if(t&&e)c.segmentation?c.segmentation.send({image:i}).catch(e=>v.error(e)):c.pending_segment.waiting=i;else{const{resolve:e,reject:t}=c.pending_segment;delete c.pending_segment,t("invalid picture size")}}})}function l(c,i,r="local"){return new Promise((e,t)=>{if(c.pending_facedetect)t("already pending facedetect");else{if(c.pending_facedetect={resolve:e,reject:t},!c.facedetect_loaded){c.facedetect_loaded=!0;const a=()=>{const e=c.facedetect=new FaceDetection({locateFile:e=>{const t="local"==r?s+"/../ext/face_detection-0.0/"+e:"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.0/"+e;return t.endsWith(".js")?o.createScriptURL(t):t}});var t;e.setOptions({modelSelection:0,minDetectionConfidence:.5}),e.onResults(e=>{if(c.pending_facedetect){const t=c.pending_facedetect["resolve"];delete c.pending_facedetect,t([e.detections,e.image])}}),c.pending_facedetect&&c.pending_facedetect.waiting&&(t=c.pending_facedetect.waiting,delete c.pending_facedetect.waiting,c.facedetect.send({image:t}).catch(e=>{}))};if(document.querySelector("script#facedetect"))c.facedetect&&c.facedetect.close(),a();else{const n=document.createElement("script");n.id="facedetect",n.setAttribute("crossorigin","anonymous");e="local"==r?s+"/../ext/face_detection-0.0/face_detection.js":"https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.0/face_detection.js";n.setAttribute("integrity","sha384-e6Te8CFt8ibDe9tEF5sw/QG3B+dk9WGZJH8UnyrJzVgdglARK03Ymw/J6RUI7yzA"),n.setAttribute("src",o.createScriptURL(e)),n.onload=()=>{a()},document.head.appendChild(n)}}t=i.videoWidth||i.naturalWidth||i.width,e=i.videoHeight||i.naturalHeight||i.height;if(t&&e)c.facedetect?c.facedetect.send({image:i}).catch(e=>{}):c.pending_facedetect.waiting=i;else{const{resolve:e,reject:t}=c.pending_facedetect;delete c.pending_facedetect,t("invalid picture size")}}})}const a={};function y(e){if(!e)return{params:null,process:null};var t=(e=Object.fromEntries(Object.values(functions).map(e=>Object.entries(e)).flat(1))[e.name]).toString().match(/^(async\s+)?function\s*(\w+\s*)?\(([^\)]*)\)\s*\{([\s\S]*)\}\s*$/);if(!t)return v.error("failed to match as valid function",e),{params:null,process:null};let a=t[3];return{params:a=a.split(",").map(e=>e.trim()).filter(e=>!!e),process:e,is_async:!!t[1]}}function w(n,c,e){if("single"==e){if(!n.pending)return n.pending=!0,new Promise((t,a)=>{try{const e=n.apply(null,c);"object"==typeof e&&e instanceof Promise?e.then(e=>{delete n.pending,t(e)}).catch(e=>{delete n.pending,u("promise rejected:",n,e),a("promise failed")}):(delete n.pending,t(e))}catch(e){u("error in function:",n,e),a("error in function: "+e.message)}})}else{if(e)return new Promise((t,a)=>{try{const e=n.apply(null,c);"object"==typeof e&&e instanceof Promise?e.then(e=>{t(e)}).catch(e=>{u("promise rejected:",n,e),a(e)}):t(e)}catch(e){u("error in function:",n,e),a(e)}});try{return n.apply(null,c)}catch(e){throw u("error in function:",n,e),new Error("error in function: "+e.message)}}}function u(e,r,t){if(t&&t.stack&&"string"==typeof t.stack){let e=t.stack.split("\n");var a=e.findIndex(e=>!!e.match(/^\s*at (Object\.)?eval\b/));const n=e[a];e=e.slice(0,a+1),n?.match(/:(\d+):(\d+)\)$/)&&(e[e.length-1]=e[e.length-1].replace(/\bat (Object\.)?eval\b/,"at function"),t.stack=e.map(e=>e.replace(/\(eval at (<anonymous>|regular_function|\w+) \(.*\), /,"(").replace(/^(.*:)(\d+)(:\d+\))$/,(e,t,a,n,c,i)=>t+(a-r.lineOffset+1)+n)).join("\n"))}v.error(e,t)}const p={enable:!1,params:null,process:null,states:[]},f={enable:!1,params:null,process:null,states:[]},j=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices),_=navigator.mediaDevices.getDisplayMedia.bind(navigator.mediaDevices),m=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);function k(e,t,a){const{params:n,process:c}=y(a);c&&(t.options=a.options,t.args=function(e,r,t){const i=r.args=t.map(e=>{switch(e){case"canvas":return r.canvas;case"data":return r.data;case"segment":return d;case"facedetect":return l;case"cleanup":return;case"options":return r.options;default:return S(e)}});let a=t.indexOf("video");0<=a?(r.video||function(e,t){let a=t.video=null;const n="screencapture"==e?{video:!0}:{},c=Object.assign(n,t.constraints1||t.constraints);delete c.audio,(a=t.video=document.createElement("video")).autoplay=!0,c.video&&j(c).then(e=>{(a.srcObject=e)&&(t.track._attached||(t.track._attached=[]),t.track._attached.push(e.getVideoTracks()[0]))}).catch(e=>{v.error("failed to get user media",e)})}(e,r),i[a]=r.video):r.video&&function(e){if(e.video){const a=e.video.srcObject;if(e.video.srcObject){e.video.srcObject=null;const n=a.getVideoTracks()[0];var t=(e.track._attached||[]).findIndex(e=>e===n);0<=t&&(e.track._attached.splice(t,0),n.stop())}e.video=null}}(r);0<=(a=t.indexOf("videos"))?(r.videos||function(n){let c=n.videos=[];const i=Object.assign({},n.constraints1||n.constraints);delete i.audio,i.video&&"object"==typeof i.video&&i.video.deviceId&&delete i.video.deviceId;m().then(e=>{const t=[];e.forEach(e=>{"videoinput"==e.kind&&t.push(e.deviceId)}),n.track._attached||(n.track._attached=[]),t.forEach((t,e)=>{const a=Object.assign({},i);"object"!=typeof a.video&&(a.video={}),a.video.deviceId={exact:t},j(a).then(e=>{const t=document.createElement("video");t.autoplay=!0,t.srcObject=e,n.track._attached.push(e.getVideoTracks()[0]),c.push(t)}).catch(e=>v.error("failed to get webcam: "+t,e))})}).catch(e=>v.error("enumerateDevices",e))}(r),i[a]=r.videos):r.videos&&function(n){n.videos&&(n.videos.forEach(e=>{const t=e.srcObject;if(e.srcObject){e.srcObject=null;const a=t.getVideoTracks()[0];e=(n.track._attached||[]).findIndex(e=>e===a);0<=e&&(n.track._attached.splice(e,0),a.stop())}}),n.videos=null)}(r);let s=t.map((e,t)=>[e,t]).filter(e=>e[0].match(/^screen\d?$/)),n=(s.forEach(([e,t])=>{if(!r[e]){var a=r;var n=e;const c=a[n]=document.createElement("video");c.autoplay=!0,_({frameRate:5}).then(e=>{c.srcObject=e,a.track._attached||(a.track._attached=[]),a.track._attached.push(e.getVideoTracks()[0]),e.oninactive=e=>{c.videoWidth=0,c.videoHeight=0}}).catch(e=>{v.error("failed to get display media",e)})}i[t]=r[e]}),Object.keys(r).filter(e=>e.match(/^screen\d?$/)));return n.sort().reverse().forEach(t=>{if(s.findIndex(e=>e[0]==t)<0){var e=r,a=t;if(e[a]){const c=e[a].srcObject;if(e[a].srcObject){e[a].srcObject=null;const i=c.getVideoTracks()[0];var n=(e.track._attached||[]).findIndex(e=>e===i);0<=n&&(e.track._attached.splice(n,0),i.stop())}e[a]=null}}}),i}(e,t,n),t.process=c,t.cleanup=n.indexOf("cleanup"))}async function n(t,e,a,i){var r=await b(a,[]),n=await b("mediastream",[]);const s={constraints:t};let o=null;if("object"==typeof r&&r[a]){const l=document.createElement("canvas");let n="screencapture"==a?{width:1280,height:960,frameRate:5}:{width:320,height:240,frameRate:15};t&&"object"==typeof t.video&&["width","height","frameRate"].forEach(e=>{"number"==typeof t.video[e]?n[e]=t.video[e]:"object"==typeof t.video[e]&&(n[e]=t.video[e].exact||t.video[e].max||n[e])}),l.width=n.width,l.height=n.height;l.getContext("2d");const u=l.captureStream(),p=(u._rtchelp=!0,u.getVideoTracks()[0]),f=Object.assign({},t||{});delete f.video;let c=null;p.applyConstraints.bind(p);p.applyConstraints=async function(a){"object"==typeof s.constraints&&s.constraints.video!==a&&(s.constraints.video=a);var e=n.frameRate;if(["width","height","frameRate"].forEach(e=>{"number"==typeof a[e]?n[e]=a[e]:"object"==typeof a[e]&&(n[e]=a[e].exact||a[e].max||n[e])}),l.width=n.width,l.height=n.height,e!=n.frameRate&&(c&&(clearInterval(c),c=null),c=setInterval(async()=>{var{process:e,args:t}=s;if(e&&t)try{await w(e,t,"single")}catch(e){}},1e3/n.frameRate)),s.video&&s.video.srcObject){const t=s.video.srcObject.getVideoTracks()[0];t&&"live"==t.readyState&&t.applyConstraints(a).catch(e=>{v.error("failed to applyConstraints",e)})}else s.videos&&0<s.videos.length&&s.videos.filter(e=>!!e.srcObject).forEach(e=>{const t=e.srcObject.getVideoTracks()[0];t&&"live"==t.readyState&&t.applyConstraints(a).catch(e=>{v.error("failed to applyConstraints",e)})})};var d=Date.now(),d=(Object.assign(s,{data:{start:d},canvas:l,track:p,video:null,process:null,args:[]}),i.states.push(s),k(a,s,r[a]),async()=>{var{process:e,args:t}=s;if(e&&t)try{await w(e,t,"single")}catch(e){}});c=setInterval(d,1e3/n.frameRate),n.frameRate<=5&&setTimeout(d,0);const m=async()=>{if(0<=s.cleanup){const{process:e,args:t}=s;if(e&&t)try{t[s.cleanup]=!0,await w(e,t,!0)}catch(e){}}};if(p.addEventListener("ended",e=>{c&&(clearInterval(c),c=null),e.currentTarget._attached&&(e.currentTarget._attached.forEach(e=>{e.stop()}),e.currentTarget._attached=null),m().catch(e=>{})}),p.stop=()=>{c&&(clearInterval(c),c=null),p._attached&&(p._attached.forEach(e=>{e.stop()}),p._attached=null),m().catch(e=>{})},f.audio)try{const g=await j(f);u.addTrack(g.getAudioTracks()[0])}catch(e){}h&&h.postMessage({type:e,constraints:t},"*"),o=Promise.resolve(u)}else o=("screencapture"==a?_:j)(t);if(!O.calling&&o&&"object"==typeof n&&n.mediastream){var{params:i,process:r}=y(n.mediastream);if(r){d=function(e,t){const{stream:a,context:n,track:c,source:i}=e;return(t||[]).map(e=>{switch(e){case"stream":return a;case"track":return c;case"source":return i;case"context":return n;case"options":return O.options;default:return S(e)}})}({stream:o=await o,context:"screencapture"==a?"getDisplayMedia":"getUserMedia"},i);O.calling+=1;let e;try{e=await w(r,d,!0)}finally{--O.calling}e&&(o=e),o=Promise.resolve(o)}}return o}navigator.mediaDevices.getUserMedia=e=>n(e,"getUserMedia","videocapture",p);const O={enable:!(navigator.mediaDevices.getDisplayMedia=e=>n(e,"getDisplayMedia","screencapture",f)),params:null,process:null,calling:0};function g(e){var{params:t,process:a}=y(e);a?(O.enable=!0,O.params=t,O.process=a,O.options=e.options):(O.enable=!1,O.params=null,O.process=null,O.options=null)}function S(e){switch(e){case"global":return a;case"respath":return s;case"console":return v;case"location":{const t="hash, host, hostname, href, origin, pathname, port, protocol, search".split(", ");return Object.keys(window.location).filter(e=>0<=t.indexOf(e)).reduce((e,t)=>(e[t]=window.location[t],e),{})}default:return}}h&&b("mediastream",[]).then(e=>{"object"==typeof e&&e.mediastream?g(e.mediastream):O.enable=!1})}var t,a;document.querySelector("html").hasAttribute("rtchelper-respath")&&(t=document.querySelector("html").getAttribute("rtchelper-respath"),a=document.querySelector("html").getAttribute("rtchelper-nonce"),document.querySelector("html").removeAttribute("rtchelper-nonce"),document.querySelector("html").removeAttribute("rtchelper-respath"),document.querySelector("html").setAttribute("rtchelper",""),e(window.BroadcastChannel?new BroadcastChannel(a):window,a,t))})();
